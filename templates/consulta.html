<!-- templates/consulta.html - VERSI√ìN COMPLETA CON D√ìLAR BCV -->
{% extends "base.html" %}

{% block title %}An√°lisis Hist√≥rico - {{ simbolo }}{% endblock %}

{% block content %}
<div class="mb-8">
    <h2 class="text-3xl font-black italic uppercase tracking-tighter">An√°lisis Hist√≥rico</h2>
    <p class="text-slate-500 dark:text-slate-400 font-bold uppercase text-xs tracking-widest">
        üìà Consulta y an√°lisis detallado por s√≠mbolo y per√≠odo
    </p>
</div>

<!-- Formulario de b√∫squeda -->
<div class="bg-white dark:bg-slate-800 p-4 md:p-6 rounded-3xl shadow-xl border border-slate-100 dark:border-slate-700 mb-8">
    <form action="/consulta" method="GET" class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
            <label class="block text-[10px] font-black uppercase mb-1 ml-1 text-slate-400">S√≠mbolo</label>
            <div class="relative">
                <input type="text" name="simbolo" value="{{ simbolo }}" 
                       placeholder="Ej: ARCA" 
                       id="simboloInput"
                       class="w-full p-3 rounded-xl border border-slate-200 dark:border-slate-800 dark:bg-slate-900 font-bold uppercase outline-none focus:ring-2 focus:ring-green-500 transition-all"
                       autocomplete="off"
                       required>
                <div id="sugerenciasContainer" class="absolute z-50 w-full mt-1 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl shadow-2xl max-h-[500px] overflow-y-auto hidden">
                    <!-- Las sugerencias se cargar√°n aqu√≠ -->
                </div>
            </div>
            <p class="text-xs text-slate-400 mt-1 ml-1">Escribe o selecciona una acci√≥n</p>
            <p id="accionesCount" class="text-xs text-green-600 dark:text-green-400 font-bold hidden">
                Cargando acciones activas...
            </p>
        </div>
        
        <div>
            <label class="block text-[10px] font-black uppercase mb-1 ml-1 text-slate-400">Fecha Desde</label>
            <input type="date" name="fecha_desde" value="{{ fecha_desde }}" 
                   class="w-full p-3 rounded-xl border border-slate-200 dark:border-slate-800 dark:bg-slate-900 font-bold outline-none focus:ring-2 focus:ring-green-500 transition-all"
                   required>
        </div>
        
        <div>
            <label class="block text-[10px] font-black uppercase mb-1 ml-1 text-slate-400">Fecha Hasta</label>
            <input type="date" name="fecha_hasta" value="{{ fecha_hasta }}" 
                   class="w-full p-3 rounded-xl border border-slate-200 dark:border-slate-800 dark:bg-slate-900 font-bold outline-none focus:ring-2 focus:ring-green-500 transition-all"
                   required>
        </div>
        
        <div class="flex items-end">
            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-black py-3 rounded-xl transition-transform active:scale-95 uppercase text-sm shadow-lg">
                üìà Consultar
            </button>
        </div>
    </form>
    
    <!-- Per√≠odos r√°pidos -->
    <div class="mt-6 pt-6 border-t border-slate-100 dark:border-slate-700">
        <p class="text-xs font-bold uppercase text-slate-400 mb-3">Per√≠odos R√°pidos:</p>
        <div class="flex flex-wrap gap-2">
            <a href="/consulta?simbolo={{ simbolo }}&fecha_desde={{ fecha_7d }}&fecha_hasta={{ fecha_hoy }}"
               class="px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white rounded-xl text-xs font-bold transition-all active:scale-95">
                √öltima Semana
            </a>
            <a href="/consulta?simbolo={{ simbolo }}&fecha_desde={{ fecha_30d }}&fecha_hasta={{ fecha_hoy }}"
               class="px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white rounded-xl text-xs font-bold transition-all active:scale-95">
                √öltimo Mes
            </a>
            <a href="/consulta?simbolo={{ simbolo }}&fecha_desde={{ fecha_90d }}&fecha_hasta={{ fecha_hoy }}"
               class="px-4 py-2 bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white rounded-xl text-xs font-bold transition-all active:scale-95">
                √öltimos 3 Meses
            </a>
            <a href="/consulta?simbolo={{ simbolo }}&fecha_desde={{ fecha_365d }}&fecha_hasta={{ fecha_hoy }}"
               class="px-4 py-2 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white rounded-xl text-xs font-bold transition-all active:scale-95">
                √öltimo A√±o
            </a>
            <!-- NUEVO: Bot√≥n Hist√≥rico Completo -->
            {% if simbolo %}
            <a href="javascript:void(0);" onclick="cargarHistoricoCompleto('{{ simbolo }}', this)"
               class="px-4 py-2 bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 text-white rounded-xl text-xs font-bold transition-all active:scale-95 flex items-center gap-1"
               id="btnHistoricoCompleto">
                üìÖ Hist√≥rico Completo
            </a>
            {% endif %}
        </div>
        <!-- Mensaje de carga para hist√≥rico completo -->
        <div id="loadingHistorico" class="hidden mt-3 text-xs text-amber-600 dark:text-amber-400 font-bold">
            <span class="animate-spin">‚è≥</span> Buscando hist√≥rico completo...
        </div>
    </div>
</div>

{% if datos_historicos %}
<!-- ========== NUEVA SECCI√ìN: COMPARACI√ìN CON D√ìLAR BCV ========== -->
{% if estadisticas_dolar and estadisticas_dolar.dias_con_dolar > 0 %}
<div class="bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-2xl border border-slate-100 dark:border-slate-700 mb-8">
    <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-black flex items-center gap-2">
            <span class="text-2xl">üí∞</span> Comparaci√≥n con D√≥lar BCV
        </h3>
        <span class="text-xs font-bold text-green-600 dark:text-green-400 bg-green-100 dark:bg-green-900/30 px-3 py-1 rounded-full">
            {{ estadisticas_dolar.dias_con_dolar }} d√≠as con datos del d√≥lar
        </span>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <div class="bg-gradient-to-br from-green-50 to-emerald-100 dark:from-green-900/20 dark:to-emerald-900/30 p-6 rounded-2xl border border-green-200 dark:border-green-800/30">
            <h4 class="text-sm font-black uppercase text-green-600 dark:text-green-400 mb-4 flex items-center gap-2">
                <span>üìä</span> Rendimiento vs D√≥lar
            </h4>
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <span class="text-sm text-green-700 dark:text-green-400">D√≠as que supera al d√≥lar</span>
                    <span class="font-bold text-lg text-green-700 dark:text-green-400">
                        {{ estadisticas_dolar.dias_supera_dolar }} d√≠as
                    </span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-green-700 dark:text-green-400">Porcentaje de d√≠as</span>
                    <span class="font-bold text-lg text-green-700 dark:text-green-400">
                        {{ estadisticas_dolar.porcentaje_supera_dolar }}%
                    </span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-slate-600 dark:text-slate-400">Diferencia promedio</span>
                    <span class="font-bold text-lg {% if estadisticas_dolar.diferencia_promedio_vs_dolar > 0 %}text-green-600 dark:text-green-400{% else %}text-red-600 dark:text-red-400{% endif %}">
                        {{ "{:+.2f}".format(estadisticas_dolar.diferencia_promedio_vs_dolar) }}%
                    </span>
                </div>
            </div>
        </div>
        
        <div class="bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-blue-900/20 dark:to-indigo-900/30 p-6 rounded-2xl border border-blue-200 dark:border-blue-800/30">
            <h4 class="text-sm font-black uppercase text-blue-600 dark:text-blue-400 mb-4 flex items-center gap-2">
                <span>üìà</span> Estad√≠sticas D√≥lar
            </h4>
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <span class="text-sm text-blue-700 dark:text-blue-400">Tasa actual</span>
                    <span class="font-bold text-lg text-blue-700 dark:text-blue-400">
                        Bs. {{ "{:,.4f}".format(estadisticas_dolar.tasa_dolar_actual) }}
                    </span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-blue-700 dark:text-blue-400">Precio en USD</span>
                    <span class="font-bold text-lg text-blue-700 dark:text-blue-400">
                        $ {{ "{:,.4f}".format(estadisticas_dolar.precio_usd_actual) }}
                    </span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-blue-700 dark:text-blue-400">Datos v√°lidos</span>
                    <span class="font-bold text-lg {% if estadisticas_dolar.dias_sin_dolar > 0 %}text-yellow-600 dark:text-yellow-400{% else %}text-green-600 dark:text-green-400{% endif %}">
                        {{ estadisticas_dolar.dias_con_dolar }}/{{ fechas_con_datos }}
                    </span>
                </div>
            </div>
        </div>
        
        <div class="bg-gradient-to-br from-purple-50 to-violet-100 dark:from-purple-900/20 dark:to-violet-900/30 p-6 rounded-2xl border border-purple-200 dark:border-purple-800/30">
            <h4 class="text-sm font-black uppercase text-purple-600 dark:text-purple-400 mb-4 flex items-center gap-2">
                <span>‚öñÔ∏è</span> Balance General
            </h4>
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <span class="text-sm text-green-700 dark:text-green-400">Supera al d√≥lar</span>
                    <span class="font-bold text-lg text-green-700 dark:text-green-400">
                        {{ estadisticas_dolar.dias_supera_dolar }}
                    </span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-red-700 dark:text-red-400">Inferior al d√≥lar</span>
                    <span class="font-bold text-lg text-red-700 dark:text-red-400">
                        {{ estadisticas_dolar.dias_inferior_dolar }}
                    </span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-blue-700 dark:text-blue-400">Igual al d√≥lar</span>
                    <span class="font-bold text-lg text-blue-700 dark:text-blue-400">
                        {{ estadisticas_dolar.dias_igual_dolar }}
                    </span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Nota sobre datos del d√≥lar -->
    {% if estadisticas_dolar.dias_sin_dolar > 0 %}
    <div class="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-xl border border-yellow-200 dark:border-yellow-800/30">
        <div class="flex items-center gap-2">
            <span class="text-yellow-600 dark:text-yellow-400 text-xl">‚ö†Ô∏è</span>
            <div>
                <p class="text-sm font-bold text-yellow-700 dark:text-yellow-400">
                    D√≠as sin datos del d√≥lar BCV: {{ estadisticas_dolar.dias_sin_dolar }}
                </p>
                <p class="text-xs text-yellow-600 dark:text-yellow-500 mt-1">
                    Para esos d√≠as, la comparaci√≥n no se puede calcular. Visite <a href="/admin/dolar-bcv" class="underline font-bold">Administraci√≥n D√≥lar BCV</a> para cargar m√°s datos.
                </p>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Tarjeta principal con estad√≠sticas -->
<div class="bg-white dark:bg-slate-800 p-6 rounded-3xl shadow-2xl border border-slate-100 dark:border-slate-700 mb-8">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
        <div class="mb-6 md:mb-0">
            <div class="flex items-center gap-4 mb-4">
                <!-- Logo de la acci√≥n -->
                <div class="relative">
                    <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-slate-100 to-slate-200 dark:from-slate-800 dark:to-slate-900 flex items-center justify-center p-2 shadow-inner">
                        <img src="/static/img/logos/{{ simbolo }}.png" 
                             onerror="this.src='https://ui-avatars.com/api/?name={{ simbolo }}&background=16a34a&color=fff&bold=true&size=256';" 
                             class="w-12 h-12 object-contain"
                             id="accionLogo">
                    </div>
                </div>
                <div>
                    <!-- Mostrar s√≠mbolo y nombre de la acci√≥n -->
                    <div class="flex items-center gap-3">
                        <h3 class="text-2xl font-black tracking-tighter uppercase">{{ simbolo }}</h3>
                        <span class="text-xs bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-300 px-2 py-1 rounded-full font-bold">
                            {{ accion_nombre }}
                        </span>
                    </div>
                    <p class="text-slate-500 dark:text-slate-400 text-sm">
                        Per√≠odo: <span class="font-bold text-green-600">{{ fecha_desde_formato }}</span> al 
                        <span class="font-bold text-green-600">{{ fecha_hasta_formato }}</span>
                        <span class="ml-4 text-xs bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded-full">
                            {{ datos_historicos|length }} registros
                        </span>
                    </p>
                </div>
            </div>
            
            <!-- Estad√≠sticas principales -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center">
                    <p class="text-[10px] font-bold text-slate-400 uppercase">Precio Inicial</p>
                    <p class="text-xl font-black text-slate-800 dark:text-white">Bs. {{ "{:,.2f}".format(precio_inicial) }}</p>
                </div>
                
                <div class="text-center">
                    <p class="text-[10px] font-bold text-slate-400 uppercase">Precio Final</p>
                    <p class="text-xl font-black text-slate-800 dark:text-white">Bs. {{ "{:,.2f}".format(precio_final) }}</p>
                </div>
                
                <div class="text-center">
                    <p class="text-[10px] font-bold text-slate-400 uppercase">Cambio (Bs)</p>
                    <p class="text-xl font-black {% if cambio_bs > 0 %}text-green-600 dark:text-green-400{% elif cambio_bs < 0 %}text-red-600 dark:text-red-400{% else %}text-slate-600 dark:text-slate-400{% endif %}">
                        {{ "{:+,.2f}".format(cambio_bs) }}
                    </p>
                </div>
                
                <div class="text-center">
                    <p class="text-[10px] font-bold text-slate-400 uppercase">Rendimiento %</p>
                    <p class="text-xl font-black {% if rendimiento_porcentaje > 0 %}text-green-600 dark:text-green-400{% elif rendimiento_porcentaje < 0 %}text-red-600 dark:text-red-400{% else %}text-slate-600 dark:text-slate-400{% endif %}">
                        {{ "{:+.2f}".format(rendimiento_porcentaje) }}%
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Bot√≥n para consultar otro s√≠mbolo -->
        <a href="/consulta" 
           class="bg-gradient-to-r from-slate-600 to-slate-700 hover:from-slate-700 hover:to-slate-800 text-white px-6 py-3 rounded-xl font-bold uppercase text-sm transition-all active:scale-95">
            üîÑ Nuevo An√°lisis
        </a>
    </div>
    
    <!-- GR√ÅFICO PRINCIPAL CON D√ìLAR BCV -->
    <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-lg mb-10">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-xl font-black text-slate-800 dark:text-white">
                Evoluci√≥n de {{ simbolo }} ({{ accion_nombre }})
                {% if estadisticas_dolar and estadisticas_dolar.dias_con_dolar > 0 %}
                <span class="text-sm font-normal text-slate-500 dark:text-slate-400 ml-2">
                    vs D√≥lar BCV
                </span>
                {% endif %}
            </h3>
            <div class="flex items-center gap-2">
                <span class="text-xs text-slate-500 dark:text-slate-400 font-bold">
                    {{ total_dias }} puntos de datos
                </span>
                {% if estadisticas_dolar and estadisticas_dolar.dias_con_dolar > 0 %}
                <span class="text-xs bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400 px-2 py-1 rounded-full">
                    {{ estadisticas_dolar.dias_con_dolar }} d√≠as con d√≥lar
                </span>
                {% endif %}
            </div>
        </div>
        
        <div class="chart-container" style="height: 400px;">
            <canvas id="graficoHistorico"></canvas>
        </div>
        
        <!-- Leyenda del gr√°fico - ACTUALIZADA CON D√ìLAR BCV -->
        <div class="mt-4 pt-4 border-t border-slate-200 dark:border-slate-700">
            <div class="flex flex-wrap gap-4 items-center justify-center text-xs">
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                    <span class="text-slate-600 dark:text-slate-300">Precio de Cierre</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 bg-purple-500 rounded-full"></div>
                    <span class="text-slate-600 dark:text-slate-300">Variaci√≥n Diaria ({{ simbolo }})</span>
                </div>
                <!-- NUEVO: Leyenda para d√≥lar BCV -->
                {% if estadisticas_dolar and estadisticas_dolar.dias_con_dolar > 0 %}
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 bg-amber-500 rounded-full"></div>
                    <span class="text-slate-600 dark:text-slate-300">Variaci√≥n D√≥lar BCV</span>
                </div>
                {% endif %}
                <div class="flex items-center gap-2">
                    <span class="text-green-600 dark:text-green-400 font-bold">üìà</span>
                    <span class="text-slate-600 dark:text-slate-300">Tendencia positiva</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-red-600 dark:text-red-400 font-bold">üìâ</span>
                    <span class="text-slate-600 dark:text-slate-300">Tendencia negativa</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ========== SECCI√ìN: COMPARTIR AN√ÅLISIS ========== -->
    <div class="mt-6 pt-6 border-t border-slate-200 dark:border-slate-700">
        <div class="flex items-center justify-between">
            <h4 class="text-lg font-black text-slate-800 dark:text-white">Compartir An√°lisis</h4>
            <button id="compartirAnalisisBtn" 
                    class="px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold rounded-xl transition-all active:scale-95 flex items-center gap-2">
                <span>üì§</span> Generar Imagen para Compartir
            </button>
        </div>
        
        <!-- Contenedor para vista previa de imagen -->
        <div id="analisisPreviewContainer" class="hidden mt-6 bg-white dark:bg-slate-800 p-6 rounded-2xl border border-slate-200 dark:border-slate-700">
            <div class="flex justify-between items-center mb-4">
                <h5 class="font-bold text-slate-800 dark:text-white">Vista Previa para Compartir</h5>
                <div class="flex gap-2">
                    <button id="descargarAnalisisBtn" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm rounded-lg flex items-center gap-1">
                        <span>üíæ</span> Descargar PNG
                    </button>
                    <button id="copiarAnalisisBtn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded-lg flex items-center gap-1">
                        <span>üìã</span> Copiar Imagen
                    </button>
                    <button id="cerrarAnalisisPreviewBtn" class="px-4 py-2 bg-slate-300 hover:bg-slate-400 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-800 dark:text-white text-sm rounded-lg">
                        ‚úï Cerrar
                    </button>
                </div>
            </div>
            <div id="analisisPreview" class="relative bg-white p-4 rounded-xl border border-slate-300 dark:border-slate-600">
                <!-- La imagen generada se mostrar√° aqu√≠ -->
                <canvas id="canvasAnalisisPreview" style="width: 100%; height: 300px; display: block;"></canvas>
            </div>
            <div class="mt-4 text-center">
                <p class="text-sm text-slate-600 dark:text-slate-400">
                    {{ simbolo }} - {{ accion_nombre }} | {{ fecha_desde_formato }} al {{ fecha_hasta_formato }}
                </p>
            </div>
        </div>
    </div>
    
    <!-- Estad√≠sticas adicionales en tarjetas -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
        <div class="bg-gradient-to-br from-slate-50 to-gray-100 dark:from-slate-900/20 dark:to-gray-900/30 p-6 rounded-2xl border border-slate-200 dark:border-slate-700">
            <h4 class="text-sm font-black uppercase text-slate-600 dark:text-slate-400 mb-4 flex items-center gap-2">
                <span>üìä</span> Estad√≠sticas
            </h4>
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <span class="text-sm text-slate-600 dark:text-slate-400">Precio M√°ximo</span>
                    <span class="font-bold text-lg text-green-600 dark:text-green-400">
                        Bs. {{ "{:,.2f}".format(precio_maximo) }}
                    </span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-slate-600 dark:text-slate-400">Precio M√≠nimo</span>
                    <span class="font-bold text-lg text-red-600 dark:text-red-400">
                        Bs. {{ "{:,.2f}".format(precio_minimo) }}
                    </span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-slate-600 dark:text-slate-400">Precio Promedio</span>
                    <span class="font-bold text-lg text-blue-600 dark:text-blue-400">
                        Bs. {{ "{:,.2f}".format(precio_promedio) }}
                    </span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-slate-600 dark:text-slate-400">Volatilidad</span>
                    <span class="font-bold text-lg text-purple-600 dark:text-purple-400">
                        {{ "{:.2f}".format(volatilidad) }}%
                    </span>
                </div>
            </div>
        </div>
        
        <div class="bg-gradient-to-br from-green-50 to-emerald-100 dark:from-green-900/20 dark:to-emerald-900/30 p-6 rounded-2xl border border-green-200 dark:border-green-800/30">
            <h4 class="text-sm font-black uppercase text-green-600 dark:text-green-400 mb-4 flex items-center gap-2">
                <span>üìà</span> Tendencias
            </h4>
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <span class="text-sm text-green-700 dark:text-green-400">D√≠as en Alza</span>
                    <span class="font-bold text-lg text-green-700 dark:text-green-400">
                        {{ dias_alza }} ({{ (dias_alza/total_dias*100)|round(1) if total_dias > 0 else 0 }}%)
                    </span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-red-700 dark:text-red-400">D√≠as en Baja</span>
                    <span class="font-bold text-lg text-red-700 dark:text-red-400">
                        {{ dias_baja }} ({{ (dias_baja/total_dias*100)|round(1) if total_dias > 0 else 0 }}%)
                    </span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-blue-700 dark:text-blue-400">D√≠as Estables</span>
                    <span class="font-bold text-lg text-blue-700 dark:text-blue-400">
                        {{ dias_estables }} ({{ (dias_estables/total_dias*100)|round(1) if total_dias > 0 else 0 }}%)
                    </span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-purple-700 dark:text-purple-400">Mayor Ganancia Diaria</span>
                    <span class="font-bold text-lg text-green-700 dark:text-green-400">
                        +{{ "{:.2f}".format(max_ganancia_diaria) }}%
                    </span>
                </div>
            </div>
        </div>
        
        <div class="bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-blue-900/20 dark:to-indigo-900/30 p-6 rounded-2xl border border-blue-200 dark:border-blue-800/30">
            <h4 class="text-sm font-black uppercase text-blue-600 dark:text-blue-400 mb-4 flex items-center gap-2">
                <span>üìã</span> Informaci√≥n
            </h4>
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <span class="text-sm text-blue-700 dark:text-blue-400">Per√≠odo Total</span>
                    <span class="font-bold text-lg">{{ total_dias }} d√≠as</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-blue-700 dark:text-blue-400">Primer Dato</span>
                    <span class="font-bold text-sm text-slate-800 dark:text-slate-200">{{ primera_fecha }}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-blue-700 dark:text-blue-400">√öltimo Dato</span>
                    <span class="font-bold text-sm text-slate-800 dark:text-slate-200">{{ ultima_fecha }}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-blue-700 dark:text-blue-400">Mayor P√©rdida Diaria</span>
                    <span class="font-bold text-lg text-red-700 dark:text-red-400">
                        {{ "{:.2f}".format(max_perdida_diaria) }}%
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabla de datos hist√≥ricos - ACTUALIZADA CON COLUMNAS DE D√ìLAR BCV -->
<div class="bg-white dark:bg-slate-800 p-4 md:p-8 rounded-3xl shadow-2xl border border-slate-100 dark:border-slate-700">
    <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-black flex items-center gap-2">
            <span class="text-2xl">üìã</span> Datos Hist√≥ricos Detallados 
            {% if datos_con_dolar and datos_con_dolar|length > 0 %}
            <span class="text-sm text-green-600 dark:text-green-400 font-normal ml-2">
                (con datos del d√≥lar BCV)
            </span>
            {% endif %}
        </h3>
        <span class="text-xs font-bold text-slate-500 dark:text-slate-400">
            P√°gina {{ pagina }} de {{ total_paginas }}
        </span>
    </div>
    
    <div class="overflow-x-auto rounded-2xl border border-slate-100 dark:border-slate-700">
        <table class="w-full text-left">
            <thead>
                <tr class="bg-slate-50 dark:bg-slate-800 text-[10px] font-black uppercase tracking-widest">
                    <th class="p-4 text-blue-600 dark:text-blue-400">Fecha</th>
                    <th class="p-4 text-right text-blue-600 dark:text-blue-400">Precio (Bs)</th>
                    <th class="p-4 text-right text-blue-600 dark:text-blue-400">Variaci√≥n %</th>
                    <!-- NUEVAS COLUMNAS PARA D√ìLAR BCV -->
                    {% if datos_con_dolar and datos_con_dolar|length > 0 %}
                    <th class="p-4 text-right text-amber-600 dark:text-amber-400">Tasa $BCV</th>
                    <th class="p-4 text-right text-amber-600 dark:text-amber-400">Var. $BCV %</th>
                    <th class="p-4 text-right text-amber-600 dark:text-amber-400">Diferencia</th>
                    <th class="p-4 text-right text-green-600 dark:text-green-400">Precio (USD)</th>
                    {% endif %}
                    <th class="p-4 text-right text-blue-600 dark:text-blue-400">Cantidad</th>
                    <th class="p-4 text-right text-blue-600 dark:text-blue-400">Monto (Bs)</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-100 dark:divide-slate-800">
                {% for dato in datos_historicos %}
                <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors group">
                    <td class="p-4 font-bold text-slate-700 dark:text-slate-300 group-hover:text-slate-900 dark:group-hover:text-white">
                        {{ dato.fecha_formateada }}
                    </td>
                    <td class="p-4 text-right font-mono font-black text-lg 
                        {% if dato.variacion > 0 %}
                            text-green-700 dark:text-green-400
                        {% elif dato.variacion < 0 %}
                            text-red-700 dark:text-red-400
                        {% else %}
                            text-slate-700 dark:text-slate-300
                        {% endif %}">
                        Bs. {{ "{:,.2f}".format(dato.precio) }}
                    </td>
                    <td class="p-4 text-right">
                        {% if dato.variacion > 0 %}
                        <span class="px-3 py-1.5 rounded-full font-black text-xs bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400">
                            +{{ "{:.2f}".format(dato.variacion) }}%
                        </span>
                        {% elif dato.variacion < 0 %}
                        <span class="px-3 py-1.5 rounded-full font-black text-xs bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400">
                            {{ "{:.2f}".format(dato.variacion) }}%
                        </span>
                        {% else %}
                        <span class="px-3 py-1.5 rounded-full font-black text-xs bg-slate-100 text-slate-500 dark:bg-slate-800 dark:text-slate-400">
                            {{ "{:.2f}".format(dato.variacion) }}%
                        </span>
                        {% endif %}
                    </td>
                    
                    <!-- NUEVAS CELDAS CON DATOS DEL D√ìLAR BCV -->
                    {% if datos_con_dolar and datos_con_dolar|length > 0 %}
                    {% set dolar_data = datos_con_dolar|selectattr('fecha', 'equalto', dato.fecha)|first %}
                    {% if dolar_data %}
                    <!-- Tasa del d√≥lar BCV -->
                    <td class="p-4 text-right font-mono font-bold text-slate-700 dark:text-slate-300">
                        <div class="flex items-center justify-end gap-1">
                            <span class="text-[10px] text-amber-500 dark:text-amber-400">Bs.</span>
                            {{ "{:,.4f}".format(dolar_data.tasa_dolar) }}
                            {% if not dolar_data.dolar_encontrado_exacto %}
                            <span class="text-[8px] text-yellow-600 dark:text-yellow-400 ml-1" title="Tasa del d√≠a anterior (no hab√≠a datos para esta fecha)">
                                ‚âà
                            </span>
                            {% endif %}
                        </div>
                    </td>
                    
                    <!-- Variaci√≥n del d√≥lar BCV -->
                    <td class="p-4 text-right">
                        {% if dolar_data.variacion_dolar_bcv > 0 %}
                        <span class="px-3 py-1.5 rounded-full font-black text-xs bg-green-50 text-green-700 dark:bg-green-900/20 dark:text-green-400 border border-green-200 dark:border-green-800">
                            +{{ "{:.2f}".format(dolar_data.variacion_dolar_bcv) }}%
                        </span>
                        {% elif dolar_data.variacion_dolar_bcv < 0 %}
                        <span class="px-3 py-1.5 rounded-full font-black text-xs bg-red-50 text-red-700 dark:bg-red-900/20 dark:text-red-400 border border-red-200 dark:border-red-800">
                            {{ "{:.2f}".format(dolar_data.variacion_dolar_bcv) }}%
                        </span>
                        {% else %}
                        <span class="px-3 py-1.5 rounded-full font-black text-xs bg-slate-50 text-slate-500 dark:bg-slate-800/50 dark:text-slate-400 border border-slate-200 dark:border-slate-700">
                            {{ "{:.2f}".format(dolar_data.variacion_dolar_bcv) }}%
                        </span>
                        {% endif %}
                    </td>
                    
                    <!-- Diferencia vs d√≥lar -->
                    <td class="p-4 text-right">
                        {% set diferencia = dolar_data.diferencia_vs_dolar %}
                        {% if diferencia > 0 %}
                        <span class="px-3 py-1.5 rounded-full font-black text-xs bg-gradient-to-r from-green-100 to-emerald-100 text-green-800 dark:from-green-900/30 dark:to-emerald-900/30 dark:text-green-300 border border-green-200 dark:border-green-800">
                            +{{ "{:.2f}".format(diferencia) }}%
                        </span>
                        {% elif diferencia < 0 %}
                        <span class="px-3 py-1.5 rounded-full font-black text-xs bg-gradient-to-r from-red-100 to-rose-100 text-red-800 dark:from-red-900/30 dark:to-rose-900/30 dark:text-red-300 border border-red-200 dark:border-red-800">
                            {{ "{:.2f}".format(diferencia) }}%
                        </span>
                        {% else %}
                        <span class="px-3 py-1.5 rounded-full font-black text-xs bg-slate-100 text-slate-500 dark:bg-slate-800 dark:text-slate-400">
                            {{ "{:.2f}".format(diferencia) }}%
                        </span>
                        {% endif %}
                    </td>
                    
                    <!-- Precio en USD -->
                    <td class="p-4 text-right font-mono font-bold text-slate-700 dark:text-slate-300">
                        <div class="flex items-center justify-end gap-1">
                            <span class="text-[10px] text-green-500 dark:text-green-400">$</span>
                            {{ "{:,.4f}".format(dolar_data.precio_usd) }}
                        </div>
                    </td>
                    {% else %}
                    <!-- Si no hay datos del d√≥lar para esta fecha -->
                    <td class="p-4 text-right text-slate-400 dark:text-slate-500" colspan="4">
                        <span class="text-xs italic">Sin datos del d√≥lar</span>
                    </td>
                    {% endif %}
                    {% endif %}
                    
                    <!-- Columnas existentes -->
                    <td class="p-4 text-right font-bold text-slate-700 dark:text-slate-300">
                        {{ "{:,}".format(dato.cantidad) }}
                    </td>
                    <td class="p-4 text-right font-bold text-slate-700 dark:text-slate-300">
                        <div class="flex items-center justify-end gap-1">
                            <span class="text-[10px] text-blue-500 dark:text-blue-400 uppercase">Bs.</span>
                            {{ "{:,.2f}".format(dato.monto) }}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Paginaci√≥n -->
    {% if total_paginas > 1 %}
    <div class="mt-8 flex justify-center">
        <div class="flex items-center gap-2">
            {% if pagina > 1 %}
            <a href="/consulta?simbolo={{ simbolo }}&fecha_desde={{ fecha_desde }}&fecha_hasta={{ fecha_hasta }}&pagina={{ pagina-1 }}"
               class="px-4 py-2 bg-slate-100 dark:bg-slate-800 rounded-lg font-bold text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                ‚Üê Anterior
            </a>
            {% endif %}
            
            <span class="px-4 py-2 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-lg font-bold">
                P√°gina {{ pagina }} de {{ total_paginas }}
            </span>
            
            {% if pagina < total_paginas %}
            <a href="/consulta?simbolo={{ simbolo }}&fecha_desde={{ fecha_desde }}&fecha_hasta={{ fecha_hasta }}&pagina={{ pagina+1 }}"
               class="px-4 py-2 bg-slate-100 dark:bg-slate-800 rounded-lg font-bold text-slate-700 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                Siguiente ‚Üí
            </a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- SCRIPT DEL GR√ÅFICO - ACTUALIZADO CON D√ìLAR BCV -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Datos para el gr√°fico
    const labels = {{ labels|tojson|safe if labels else '[]' }};
    const precios = {{ valores|tojson|safe if valores else '[]' }};
    const cambios = {{ cambios|tojson|safe if cambios else '[]' }};
    
    // Datos del d√≥lar BCV si est√°n disponibles
    const tieneDatosDolar = {{ 'true' if datos_con_dolar and datos_con_dolar|length > 0 else 'false' }};
    let cambiosDolar = [];
    
    if (tieneDatosDolar) {
        // Preparar datos del d√≥lar BCV para el gr√°fico
        const datosConDolar = {{ datos_con_dolar|tojson|safe if datos_con_dolar else '[]' }};
        
        // Filtrar y alinear datos del d√≥lar con las fechas del gr√°fico
        if (labels && datosConDolar) {
            cambiosDolar = labels.map((label, index) => {
                // Encontrar el dato del d√≥lar correspondiente a esta fecha
                // Para simplificar, usamos el mismo √≠ndice si los arrays est√°n alineados
                // En producci√≥n, se necesitar√≠a un mapeo m√°s preciso
                if (datosConDolar[index]) {
                    return datosConDolar[index].variacion_dolar_bcv || 0;
                }
                return 0;
            });
        }
    }
    
    console.log("üìä Datos para gr√°fico:", { labels, precios, cambios, cambiosDolar });
    
    if (!labels || labels.length === 0 || !precios || precios.length === 0) {
        console.log("‚ö†Ô∏è No hay datos para mostrar en el gr√°fico");
        
        // Mostrar mensaje de no datos
        const chartContainer = document.querySelector('.chart-container');
        if (chartContainer) {
            chartContainer.innerHTML = `
                <div class="text-center py-20">
                    <div class="text-4xl mb-2">üìä</div>
                    <h4 class="text-lg font-black mb-2">No hay datos disponibles</h4>
                    <p class="text-slate-500 dark:text-slate-400">Selecciona otro rango de fechas para visualizar el hist√≥rico.</p>
                </div>
            `;
        }
        return;
    }
    
    const ctx = document.getElementById('graficoHistorico').getContext('2d');
    
    // Determinar color de l√≠nea basado en el rendimiento
    const rendimiento = {{ rendimiento_porcentaje|tojson|safe }};
    let colorLinea = 'rgb(59, 130, 246)'; // Azul por defecto
    
    if (rendimiento > 0) {
        colorLinea = 'rgb(34, 197, 94)'; // Verde para positivo
    } else if (rendimiento < 0) {
        colorLinea = 'rgb(239, 68, 68)'; // Rojo para negativo
    }
    
    // Crear degradado para el fondo
    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, colorLinea.replace('rgb', 'rgba').replace(')', ', 0.2)'));
    gradient.addColorStop(1, colorLinea.replace('rgb', 'rgba').replace(')', ', 0)'));
    
    // Configurar datasets
    const datasets = [
        {
            label: 'Precio de Cierre (Bs)',
            data: precios,
            borderColor: colorLinea,
            backgroundColor: gradient,
            borderWidth: 3,
            pointRadius: 4,
            pointHoverRadius: 8,
            pointBackgroundColor: colorLinea,
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            fill: true,
            tension: 0.4,
            yAxisID: 'y'
        },
        {
            label: 'Variaci√≥n Diaria (%)',
            data: cambios,
            borderColor: 'rgb(168, 85, 247)', // P√∫rpura
            backgroundColor: 'transparent',
            borderWidth: 2,
            borderDash: [5, 5],
            pointRadius: 3,
            pointHoverRadius: 6,
            pointBackgroundColor: 'rgba(168, 85, 247, 0.8)',
            pointBorderColor: 'rgb(168, 85, 247)',
            pointBorderWidth: 2,
            fill: false,
            tension: 0.4,
            yAxisID: 'y1'
        }
    ];
    
    // Agregar dataset del d√≥lar BCV si hay datos
    if (tieneDatosDolar && cambiosDolar.length > 0) {
        datasets.push({
            label: 'Variaci√≥n D√≥lar BCV (%)',
            data: cambiosDolar,
            borderColor: 'rgb(245, 158, 11)', // √Åmbar/naranja
            backgroundColor: 'rgba(245, 158, 11, 0.1)',
            borderWidth: 3,
            pointRadius: 3,
            pointHoverRadius: 7,
            pointBackgroundColor: 'rgba(245, 158, 11, 0.8)',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            fill: false,
            tension: 0.3,
            yAxisID: 'y1'
        });
    }
    
    // Crear el gr√°fico
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        font: {
                            size: 12,
                            family: "'Inter', sans-serif"
                        },
                        padding: 20,
                        usePointStyle: true,
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(15, 23, 42, 0.95)',
                    titleFont: {
                        family: "'Inter', sans-serif",
                        size: 12
                    },
                    bodyFont: {
                        family: "'Inter', sans-serif",
                        size: 12
                    },
                    padding: 12,
                    cornerRadius: 8,
                    borderColor: '#475569',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            let label = '';
                            if (context.datasetIndex === 0) {
                                label = `Precio: Bs ${context.parsed.y.toLocaleString('es-VE', { 
                                    minimumFractionDigits: 2, 
                                    maximumFractionDigits: 2 
                                })}`;
                            } else if (context.datasetIndex === 1) {
                                label = `Variaci√≥n ${context.dataset.label}: ${context.parsed.y.toFixed(2)}%`;
                            } else if (context.datasetIndex === 2) {
                                label = `Variaci√≥n D√≥lar BCV: ${context.parsed.y.toFixed(2)}%`;
                            }
                            return label;
                        },
                        title: function(context) {
                            const label = context[0].label;
                            if (label) {
                                return `Fecha: ${label}`;
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: true,
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45,
                        font: {
                            family: "'Inter', sans-serif",
                            size: 11
                        },
                        color: '#64748b'
                    }
                },
                y: {
                    beginAtZero: false,
                    grid: {
                        display: true,
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        callback: function(value) {
                            return `Bs ${value.toLocaleString('es-VE')}`;
                        },
                        font: {
                            family: "'Inter', sans-serif",
                            size: 11
                        },
                        color: '#64748b'
                    },
                    title: {
                        display: true,
                        text: 'Precio (Bs)',
                        font: {
                            family: "'Inter', sans-serif",
                            size: 12,
                            weight: 'bold'
                        },
                        color: '#64748b'
                    }
                },
                y1: {
                    beginAtZero: true,
                    position: 'right',
                    grid: {
                        drawOnChartArea: false,
                    },
                    ticks: {
                        callback: function(value) {
                            return `${value.toFixed(1)}%`;
                        },
                        font: {
                            family: "'Inter', sans-serif",
                            size: 11
                        },
                        color: '#8b5cf6'
                    },
                    title: {
                        display: true,
                        text: 'Variaci√≥n (%)',
                        font: {
                            family: "'Inter', sans-serif",
                            size: 12,
                            weight: 'bold'
                        },
                        color: '#8b5cf6'
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            },
            animation: {
                duration: 1000,
                easing: 'easeOutQuart'
            }
        }
    });
    
    // Exponer chart globalmente
    window.consultaChart = chart;
    
    // ========== FUNCIONALIDAD PARA COMPARTIR AN√ÅLISIS ==========
    const compartirAnalisisBtn = document.getElementById('compartirAnalisisBtn');
    const previewContainer = document.getElementById('analisisPreviewContainer');
    const descargarBtn = document.getElementById('descargarAnalisisBtn');
    const copiarBtn = document.getElementById('copiarAnalisisBtn');
    const cerrarBtn = document.getElementById('cerrarAnalisisPreviewBtn');
    const canvasPreview = document.getElementById('canvasAnalisisPreview');
    
    let analisisImageUrl = null;
    
    // Datos de la acci√≥n (disponibles desde Jinja2)
    const simboloAccion = '{{ simbolo }}';
    const nombreAccion = '{{ accion_nombre }}';
    const periodoDesde = '{{ fecha_desde_formato }}';
    const periodoHasta = '{{ fecha_hasta_formato }}';
    const rendimientoPorcentaje = {{ rendimiento_porcentaje|tojson|safe }};
    const precioActual = {{ precio_final|tojson|safe }};
    const precioMaximo = {{ precio_maximo|tojson|safe }};
    const precioMinimo = {{ precio_minimo|tojson|safe }};
    const precioPromedio = {{ precio_promedio|tojson|safe }};
    const volatilidadValor = {{ volatilidad|tojson|safe }};
    const totalDiasAnalizados = {{ total_dias|tojson|safe }};
    const maxGananciaDiaria = {{ max_ganancia_diaria|tojson|safe }};
    
    // Funci√≥n para generar imagen del an√°lisis - VERSI√ìN MEJORADA CON FONDOS PERSONALIZADOS
    async function generarImagenAnalisis() {
        try {
            // Mostrar estado de carga
            const originalText = compartirAnalisisBtn.innerHTML;
            compartirAnalisisBtn.innerHTML = '<span class="animate-spin">‚è≥</span> Generando imagen...';
            compartirAnalisisBtn.disabled = true;
            
            // Crear canvas temporal
            const tempCanvas = document.createElement('canvas');
            const ctx = tempCanvas.getContext('2d');
            
            // Dimensiones √≥ptimas para compartir (1200x630 es ideal para redes sociales)
            tempCanvas.width = 1200;
            tempCanvas.height = 630;
            
            // ===== FONDO CON IMAGEN PERSONALIZADA =====
            // Determinar qu√© imagen usar seg√∫n el tema
            const esTemaOscuro = document.documentElement.classList.contains('dark');
            const fondoUrl = esTemaOscuro ? '/static/compartir_white.png' : '/static/compartir_black.png';
            
            // Cargar imagen de fondo
            const fondoImg = new Image();
            fondoImg.crossOrigin = 'anonymous';
            
            await new Promise((resolve, reject) => {
                fondoImg.onload = resolve;
                fondoImg.onerror = (err) => {
                    console.error('Error cargando fondo personalizado:', err);
                    // Fallback a fondo s√≥lido si la imagen no carga
                    const fallbackGradient = ctx.createLinearGradient(0, 0, tempCanvas.width, tempCanvas.height);
                    if (esTemaOscuro) {
                        fallbackGradient.addColorStop(0, '#0f172a'); // Azul muy oscuro
                        fallbackGradient.addColorStop(1, '#1e293b'); // Azul oscuro
                    } else {
                        fallbackGradient.addColorStop(0, '#f8fafc'); // Blanco azulado
                        fallbackGradient.addColorStop(1, '#e2e8f0'); // Gris claro
                    }
                    ctx.fillStyle = fallbackGradient;
                    ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                    resolve();
                };
                fondoImg.src = fondoUrl;
            });
            
            // Dibujar fondo solo si la imagen carg√≥ correctamente
            if (fondoImg.complete && fondoImg.naturalWidth !== 0) {
                // Ajustar la imagen al tama√±o del canvas manteniendo la proporci√≥n
                const scale = Math.max(
                    tempCanvas.width / fondoImg.width,
                    tempCanvas.height / fondoImg.height
                );
                const x = (tempCanvas.width / 2) - (fondoImg.width / 2) * scale;
                const y = (tempCanvas.height / 2) - (fondoImg.height / 2) * scale;
                
                ctx.drawImage(fondoImg, x, y, fondoImg.width * scale, fondoImg.height * scale);
            }
            
            // A√±adir una capa semi-transparente para mejorar legibilidad
            ctx.fillStyle = esTemaOscuro 
                ? 'rgba(15, 23, 42, 0.4)' 
                : 'rgba(255, 255, 255, 0.6)';
            ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            
            // ===== TARJETA PRINCIPAL CON BORDES REDONDEADOS =====
            const cardWidth = tempCanvas.width * 0.9;
            const cardHeight = tempCanvas.height * 0.8;
            const cardX = (tempCanvas.width - cardWidth) / 2;
            const cardY = (tempCanvas.height - cardHeight) / 2;
            
            // Fondo de la tarjeta con gradiente y sombra
            const cardGradient = esTemaOscuro 
                ? ctx.createLinearGradient(cardX, cardY, cardX, cardY + cardHeight)
                : ctx.createLinearGradient(cardX, cardY, cardX, cardY + cardHeight);
            
            if (esTemaOscuro) {
                cardGradient.addColorStop(0, 'rgba(30, 41, 59, 0.95)'); // Azul oscuro
                cardGradient.addColorStop(1, 'rgba(15, 23, 42, 0.98)'); // Azul m√°s oscuro
            } else {
                cardGradient.addColorStop(0, 'rgba(255, 255, 255, 0.95)');
                cardGradient.addColorStop(1, 'rgba(255, 255, 255, 0.98)');
            }
            
            // Sombra de la tarjeta
            ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
            ctx.shadowBlur = 30;
            ctx.shadowOffsetX = 0;
            ctx.shadowOffsetY = 15;
            
            // Dibujar tarjeta con bordes redondeados
            ctx.fillStyle = cardGradient;
            roundRect(ctx, cardX, cardY, cardWidth, cardHeight, 30);
            ctx.fill();
            ctx.shadowColor = 'transparent'; // Resetear sombra
            
            // ===== ENCABEZADO CON LOGO DE LA ACCI√ìN =====
            const headerHeight = 120;
            
            // Fondo del encabezado con gradiente
            const headerGradient = ctx.createLinearGradient(cardX, cardY, cardX, cardY + headerHeight);
            headerGradient.addColorStop(0, '#059669'); // Verde
            headerGradient.addColorStop(1, '#047857'); // Verde oscuro
            ctx.fillStyle = headerGradient;
            roundRect(ctx, cardX, cardY, cardWidth, headerHeight, {tl: 30, tr: 30, bl: 0, br: 0});
            ctx.fill();
            
            // Logo peque√±o de la acci√≥n
            const logoSize = 70;
            const logoUrl = `/static/img/logos/${simboloAccion}.png`;
            const fallbackLogo = `https://ui-avatars.com/api/?name=${simboloAccion}&background=16a34a&color=fff&bold=true&size=512`;
            
            const logoImg = new Image();
            logoImg.crossOrigin = 'anonymous';
            
            await new Promise((resolve) => {
                logoImg.onload = resolve;
                logoImg.onerror = () => {
                    logoImg.src = fallbackLogo;
                    logoImg.onload = resolve;
                };
                logoImg.src = logoUrl;
            });
            
            ctx.globalAlpha = 0.9;
            ctx.drawImage(logoImg, 
                cardX + 40, 
                cardY + (headerHeight - logoSize) / 2,
                logoSize, logoSize
            );
            ctx.globalAlpha = 1.0;
            
            // T√≠tulo principal
            ctx.font = 'bold 42px "Segoe UI", Arial, sans-serif';
            ctx.fillStyle = '#ffffff';
            ctx.textAlign = 'left';
            ctx.fillText('AN√ÅLISIS BURS√ÅTIL', cardX + 130, cardY + 70);
            
            // Subt√≠tulo
            ctx.font = 'bold 24px "Segoe UI", Arial, sans-serif';
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.fillText('BVC - GenaroCoin', cardX + 130, cardY + 100);
            
            // ===== INFORMACI√ìN DE LA ACCI√ìN =====
            const infoX = cardX + 40;
            let infoY = cardY + headerHeight + 50;
            
            // S√≠mbolo y nombre de la acci√≥n
            ctx.font = 'bold 64px "Segoe UI", Arial, sans-serif';
            ctx.fillStyle = esTemaOscuro ? '#f1f5f9' : '#1f2937'; // Color seg√∫n tema
            ctx.textAlign = 'left';
            ctx.fillText(simboloAccion, infoX, infoY);
            
            ctx.font = '28px "Segoe UI", Arial, sans-serif';
            ctx.fillStyle = esTemaOscuro ? '#94a3b8' : '#6b7280'; // Color seg√∫n tema
            ctx.fillText(nombreAccion, infoX + 150, infoY);
            
            // Per√≠odo analizado
            ctx.font = '20px "Segoe UI", Arial, sans-serif';
            ctx.fillStyle = esTemaOscuro ? '#cbd5e1' : '#9ca3af'; // Color seg√∫n tema
            ctx.fillText(`${periodoDesde} al ${periodoHasta}`, infoX, infoY + 40);
            
            // ===== DATOS PRINCIPALES (LADO IZQUIERDO) =====
            const datosY = infoY + 100;
            
            // Precio Actual
            ctx.font = 'bold 72px "Segoe UI", Arial, sans-serif';
            ctx.fillStyle = esTemaOscuro ? '#f1f5f9' : '#1f2937';
            ctx.fillText(`Bs. ${precioActual.toLocaleString('es-VE', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`, infoX, datosY);
            
            // Rendimiento con icono
            const rendimientoIcono = rendimientoPorcentaje > 0 ? 'üìà' : rendimientoPorcentaje < 0 ? 'üìâ' : '‚öñÔ∏è';
            const rendimientoColor = rendimientoPorcentaje > 0 ? '#10b981' : rendimientoPorcentaje < 0 ? '#ef4444' : '#6b7280';
            
            ctx.font = 'bold 52px "Segoe UI", Arial, sans-serif';
            ctx.fillStyle = rendimientoColor;
            ctx.fillText(`${rendimientoIcono} ${rendimientoPorcentaje > 0 ? '+' : ''}${rendimientoPorcentaje.toFixed(2)}%`, infoX, datosY + 80);
            
            // ===== GR√ÅFICA MEJORADA (LADO DERECHO) =====
            const graphX = cardX + cardWidth * 0.55;
            const graphY = infoY;
            const graphWidth = cardWidth * 0.4;
            const graphHeight = 200;
            
            // T√≠tulo del gr√°fico
            ctx.font = 'bold 24px "Segoe UI", Arial, sans-serif';
            ctx.fillStyle = esTemaOscuro ? '#e2e8f0' : '#374151';
            ctx.textAlign = 'left';
            ctx.fillText('EVOLUCI√ìN', graphX, graphY - 10);
            
            // Dibujar √°rea del gr√°fico con fondo
            if (precios && precios.length > 0) {
                const puntos = precios;
                const minVal = Math.min(...puntos);
                const maxVal = Math.max(...puntos);
                const range = maxVal - minVal;
                
                // Fondo del √°rea del gr√°fico
                ctx.fillStyle = esTemaOscuro ? 'rgba(30, 41, 59, 0.8)' : 'rgba(249, 250, 251, 0.8)';
                roundRect(ctx, graphX, graphY, graphWidth, graphHeight, 15);
                ctx.fill();
                
                // L√≠neas de grid horizontales
                ctx.strokeStyle = esTemaOscuro ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.05)';
                ctx.lineWidth = 1;
                for (let i = 0; i <= 4; i++) {
                    const y = graphY + (i * graphHeight / 4);
                    ctx.beginPath();
                    ctx.moveTo(graphX, y);
                    ctx.lineTo(graphX + graphWidth, y);
                    ctx.stroke();
                }
                
                // L√≠nea del gr√°fico - ARREGLADA (sin cortes)
                ctx.strokeStyle = rendimientoColor;
                ctx.lineWidth = 4;
                ctx.lineJoin = 'round';
                ctx.lineCap = 'round';
                ctx.beginPath();
                
                // Calcular puntos asegurando que est√©n dentro del √°rea visible
                for (let i = 0; i < puntos.length; i++) {
                    const x = graphX + (i / (puntos.length - 1)) * graphWidth;
                    const yValue = puntos[i];
                    
                    // Asegurar que el valor est√© dentro del rango
                    const normalizedY = ((yValue - minVal) / range);
                    const y = graphY + graphHeight - (normalizedY * graphHeight);
                    
                    // Ajustar posici√≥n para no tocar los bordes
                    const adjustedY = Math.max(graphY + 5, Math.min(graphY + graphHeight - 5, y));
                    const adjustedX = Math.max(graphX + 5, Math.min(graphX + graphWidth - 5, x));
                    
                    if (i === 0) {
                        ctx.moveTo(adjustedX, adjustedY);
                    } else {
                        ctx.lineTo(adjustedX, adjustedY);
                    }
                }
                
                ctx.stroke();
                
                // Relleno debajo de la l√≠nea
                ctx.lineTo(graphX + graphWidth, graphY + graphHeight);
                ctx.lineTo(graphX, graphY + graphHeight);
                ctx.closePath();
                ctx.fillStyle = rendimientoColor.replace('rgb', 'rgba').replace(')', ', 0.1)');
                ctx.fill();
                
                // Puntos en los extremos
                const drawPoint = (index, color) => {
                    if (puntos[index] !== undefined) {
                        const x = graphX + (index / (puntos.length - 1)) * graphWidth;
                        const yValue = puntos[index];
                        const normalizedY = ((yValue - minVal) / range);
                        const y = graphY + graphHeight - (normalizedY * graphHeight);
                        
                        const adjustedY = Math.max(graphY + 5, Math.min(graphY + graphHeight - 5, y));
                        const adjustedX = Math.max(graphX + 5, Math.min(graphX + graphWidth - 5, x));
                        
                        ctx.beginPath();
                        ctx.arc(adjustedX, adjustedY, 8, 0, Math.PI * 2);
                        ctx.fillStyle = color;
                        ctx.fill();
                        ctx.strokeStyle = '#ffffff';
                        ctx.lineWidth = 3;
                        ctx.stroke();
                    }
                };
                
                // Punto inicial (verde)
                drawPoint(0, '#10b981');
                // Punto final (color seg√∫n rendimiento)
                drawPoint(puntos.length - 1, rendimientoColor);
            }
            
            // ===== ESTAD√çSTICAS ORGANIZADAS EN TABLA =====
            const statsX = cardX + 40;
            const statsY = datosY + 150;
            
            // T√≠tulo de estad√≠sticas
            ctx.font = 'bold 32px "Segoe UI", Arial, sans-serif';
            ctx.fillStyle = esTemaOscuro ? '#e2e8f0' : '#374151';
            ctx.textAlign = 'left';
            ctx.fillText('ESTAD√çSTICAS', statsX, statsY);
            
            // Lista de estad√≠sticas en dos columnas
            const estadisticasColumn1 = [
                {label: 'Precio M√°ximo', value: `Bs. ${precioMaximo.toLocaleString('es-VE', {minimumFractionDigits: 2})}`, color: '#10b981'},
                {label: 'Precio M√≠nimo', value: `Bs. ${precioMinimo.toLocaleString('es-VE', {minimumFractionDigits: 2})}`, color: '#ef4444'},
                {label: 'Precio Promedio', value: `Bs. ${precioPromedio.toLocaleString('es-VE', {minimumFractionDigits: 2})}`, color: '#3b82f6'}
            ];
            
            const estadisticasColumn2 = [
                {label: 'Volatilidad', value: `${volatilidadValor.toFixed(2)}%`, color: '#8b5cf6'},
                {label: 'D√≠as Analizados', value: totalDiasAnalizados, color: '#f59e0b'},
                {label: 'Mayor Ganancia', value: `+${maxGananciaDiaria.toFixed(2)}%`, color: '#10b981'}
            ];
            
            // Funci√≥n para dibujar una fila de estad√≠stica
            const dibujarEstadistica = (estadistica, x, y, ancho) => {
                // Etiqueta
                ctx.font = '20px "Segoe UI", Arial, sans-serif';
                ctx.fillStyle = esTemaOscuro ? '#94a3b8' : '#6b7280';
                ctx.textAlign = 'left';
                ctx.fillText(estadistica.label, x, y);
                
                // Valor
                ctx.font = 'bold 24px "Segoe UI", Arial, sans-serif';
                ctx.fillStyle = estadistica.color;
                ctx.textAlign = 'right';
                
                const valorText = typeof estadistica.value === 'number' 
                    ? estadistica.value.toLocaleString('es-VE') 
                    : estadistica.value;
                ctx.fillText(valorText, x + ancho, y);
            };
            
            // Dibujar primera columna
            const anchoColumna = 300;
            let offsetY = 0;
            estadisticasColumn1.forEach((stat, index) => {
                const yPos = statsY + 50 + (offsetY * 60);
                dibujarEstadistica(stat, statsX, yPos, anchoColumna);
                offsetY++;
            });
            
            // Dibujar segunda columna
            offsetY = 0;
            estadisticasColumn2.forEach((stat, index) => {
                const yPos = statsY + 50 + (offsetY * 60);
                dibujarEstadistica(stat, statsX + anchoColumna + 50, yPos, anchoColumna);
                offsetY++;
            });
            
            // Separador visual entre columnas
            ctx.strokeStyle = esTemaOscuro ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(statsX + anchoColumna + 25, statsY + 40);
            ctx.lineTo(statsX + anchoColumna + 25, statsY + 210);
            ctx.stroke();
            
            // ===== PIE DE P√ÅGINA =====
            const footerY = cardY + cardHeight - 40;
            
            // L√≠nea decorativa
            ctx.strokeStyle = esTemaOscuro ? '#475569' : '#e5e7eb';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(cardX + 40, footerY - 20);
            ctx.lineTo(cardX + cardWidth - 40, footerY - 20);
            ctx.stroke();
            
            // Texto del pie de p√°gina
            ctx.font = 'bold 20px "Segoe UI", Arial, sans-serif';
            ctx.fillStyle = esTemaOscuro ? '#94a3b8' : '#6b7280';
            ctx.textAlign = 'center';
            ctx.fillText('BVC - GenaroCoin - Invierte en Venezuela', cardX + cardWidth / 2, footerY);
            
            // Fecha de generaci√≥n
            ctx.font = '16px "Segoe UI", Arial, sans-serif';
            ctx.fillStyle = esTemaOscuro ? '#cbd5e1' : '#9ca3af';
            const fechaGeneracion = new Date().toLocaleDateString('es-VE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            ctx.fillText(`Generado: ${fechaGeneracion}`, cardX + cardWidth / 2, footerY + 25);
            
            // ===== MOSTRAR VISTA PREVIA =====
            // Ajustar tama√±o del canvas de preview
            canvasPreview.width = tempCanvas.width;
            canvasPreview.height = tempCanvas.height;
            const previewCtx = canvasPreview.getContext('2d');
            previewCtx.drawImage(tempCanvas, 0, 0);
            
            // Redimensionar para mostrar en el contenedor
            canvasPreview.style.width = '100%';
            canvasPreview.style.height = 'auto';
            
            // Convertir a URL para descargar/compartir
            analisisImageUrl = tempCanvas.toDataURL('image/png');
            
            // Mostrar preview
            previewContainer.classList.remove('hidden');
            
            // Restaurar bot√≥n
            compartirAnalisisBtn.innerHTML = originalText;
            compartirAnalisisBtn.disabled = false;
            
            // Desplazar hacia la vista previa
            previewContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
        } catch (error) {
            console.error('Error generando imagen de an√°lisis:', error);
            alert('Error al generar la imagen. Int√©ntalo de nuevo.');
            
            // Restaurar bot√≥n en caso de error
            compartirAnalisisBtn.innerHTML = '<span>üì§</span> Generar Imagen para Compartir';
            compartirAnalisisBtn.disabled = false;
        }
    }
    
    // Funci√≥n auxiliar para dibujar rect√°ngulos con bordes redondeados
    function roundRect(ctx, x, y, width, height, radius) {
        if (typeof radius === 'number') {
            radius = {tl: radius, tr: radius, br: radius, bl: radius};
        } else {
            radius = {...{tl: 0, tr: 0, br: 0, bl: 0}, ...radius};
        }
        
        ctx.beginPath();
        ctx.moveTo(x + radius.tl, y);
        ctx.lineTo(x + width - radius.tr, y);
        ctx.quadraticCurveTo(x + width, y, x + width, y + radius.tr);
        ctx.lineTo(x + width, y + height - radius.br);
        ctx.quadraticCurveTo(x + width, y + height, x + width - radius.br, y + height);
        ctx.lineTo(x + radius.bl, y + height);
        ctx.quadraticCurveTo(x, y + height, x, y + height - radius.bl);
        ctx.lineTo(x, y + radius.tl);
        ctx.quadraticCurveTo(x, y, x + radius.tl, y);
        ctx.closePath();
    }
    
    // Event Listeners
    if (compartirAnalisisBtn) {
        compartirAnalisisBtn.addEventListener('click', generarImagenAnalisis);
    }
    
    if (descargarBtn) {
        descargarBtn.addEventListener('click', function() {
            if (!analisisImageUrl) return;
            
            const a = document.createElement('a');
            a.href = analisisImageUrl;
            a.download = `BVC_Analisis_${simboloAccion}_${new Date().toISOString().split('T')[0]}.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            // Mostrar confirmaci√≥n
            const originalText = descargarBtn.innerHTML;
            descargarBtn.innerHTML = '<span>‚úÖ</span> ¬°Descargado!';
            setTimeout(() => {
                descargarBtn.innerHTML = originalText;
            }, 2000);
        });
    }
    
    if (copiarBtn) {
        copiarBtn.addEventListener('click', async function() {
            if (!analisisImageUrl) return;
            
            try {
                // Mostrar estado de carga
                const originalText = copiarBtn.innerHTML;
                copiarBtn.innerHTML = '<span class="animate-spin">‚è≥</span> Copiando...';
                
                // Convertir data URL a blob
                const response = await fetch(analisisImageUrl);
                const blob = await response.blob();
                
                // Copiar al portapapeles
                await navigator.clipboard.write([
                    new ClipboardItem({
                        'image/png': blob
                    })
                ]);
                
                // Mostrar confirmaci√≥n
                copiarBtn.innerHTML = '<span>‚úÖ</span> ¬°Copiado!';
                setTimeout(() => {
                    copiarBtn.innerHTML = originalText;
                }, 2000);
                
            } catch (error) {
                console.error('Error copiando imagen:', error);
                
                // Fallback: Descargar si no se puede copiar
                if (!analisisImageUrl) return;
                const a = document.createElement('a');
                a.href = analisisImageUrl;
                a.download = `BVC_Analisis_${simboloAccion}_${new Date().toISOString().split('T')[0]}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                copiarBtn.innerHTML = '<span>üíæ</span> Se descarg√≥ en su lugar';
                setTimeout(() => {
                    copiarBtn.innerHTML = originalText;
                }, 2000);
            }
        });
    }
    
    if (cerrarBtn) {
        cerrarBtn.addEventListener('click', function() {
            previewContainer.classList.add('hidden');
        });
    }
    
    // Funci√≥n para cargar hist√≥rico completo
    window.cargarHistoricoCompleto = function(simbolo, elemento) {
        console.log(`üîç Solicitando hist√≥rico completo para: ${simbolo}`);
        
        // Mostrar loading
        const btnHistorico = document.getElementById('btnHistoricoCompleto');
        const loadingDiv = document.getElementById('loadingHistorico');
        const textoOriginal = btnHistorico.innerHTML;
        
        btnHistorico.innerHTML = '<span class="animate-spin">‚è≥</span> Cargando...';
        btnHistorico.classList.add('opacity-50', 'cursor-not-allowed');
        loadingDiv.classList.remove('hidden');
        
        // Obtener la fecha m√°s antigua disponible para esta acci√≥n
        fetch(`/api/historico-completo?simbolo=${simbolo}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('üìä Respuesta de la API:', data);
                
                if (data.success) {
                    // Actualizar el formulario con las fechas obtenidas
                    const fechaDesdeInput = document.querySelector('input[name="fecha_desde"]');
                    const fechaHastaInput = document.querySelector('input[name="fecha_hasta"]');
                    
                    if (fechaDesdeInput && fechaHastaInput) {
                        fechaDesdeInput.value = data.fecha_desde;
                        fechaHastaInput.value = data.fecha_hasta;
                        
                        console.log(`üìÖ Fechas actualizadas: ${data.fecha_desde} a ${data.fecha_hasta}`);
                        
                        // Actualizar mensaje de carga
                        loadingDiv.innerHTML = `<span class="animate-spin">‚è≥</span> Cargando datos desde ${data.primera_fecha} hasta ${data.ultima_fecha}...`;
                        
                        // Enviar el formulario autom√°ticamente despu√©s de un breve retraso
                        setTimeout(() => {
                            document.querySelector('form').submit();
                        }, 1000);
                    } else {
                        alert('Error: No se encontraron los campos de fecha');
                        resetBoton();
                    }
                } else {
                    alert('Error: ' + data.message);
                    console.error('Error de la API:', data);
                    resetBoton();
                }
            })
            .catch(error => {
                console.error('Error en fetch:', error);
                alert('Error al conectar con el servidor. Verifica la consola para m√°s detalles.');
                resetBoton();
            });
        
        function resetBoton() {
            btnHistorico.innerHTML = textoOriginal;
            btnHistorico.classList.remove('opacity-50', 'cursor-not-allowed');
            loadingDiv.classList.add('hidden');
        }
    }
});

// NUEVO: Script para autocomplete din√°mico de acciones ACTIVAS
document.addEventListener('DOMContentLoaded', function() {
    const simboloInput = document.getElementById('simboloInput');
    const sugerenciasContainer = document.getElementById('sugerenciasContainer');
    const accionesCount = document.getElementById('accionesCount');
    
    let accionesActivas = [];
    let cargandoAcciones = false;
    
    // Funci√≥n para cargar acciones activas desde la API
    async function cargarAccionesActivas() {
        if (cargandoAcciones) return;
        
        cargandoAcciones = true;
        accionesCount.classList.remove('hidden');
        accionesCount.textContent = 'üîÑ Cargando acciones activas del √∫ltimo mes...';
        
        try {
            const response = await fetch('/api/acciones-activas');
            const data = await response.json();
            
            if (data.success && data.acciones && data.acciones.length > 0) {
                accionesActivas = data.acciones;
                accionesCount.textContent = `‚úÖ ${accionesActivas.length} acciones activas en el √∫ltimo mes`;
                accionesCount.className = 'text-xs text-green-600 dark:text-green-400 font-bold';
                
                console.log(`Cargadas ${accionesActivas.length} acciones activas desde ${data.fecha_limite}`);
                
                // Si el campo est√° vac√≠o, mostrar todas las acciones activas
                if (!simboloInput.value.trim()) {
                    mostrarTodasAccionesActivas();
                }
            } else {
                accionesCount.textContent = '‚ö†Ô∏è No se pudieron cargar las acciones activas, intentando con todas...';
                accionesCount.className = 'text-xs text-yellow-600 dark:text-yellow-400 font-bold';
                
                // Intentar con la API de todas las acciones
                await cargarTodasAcciones();
            }
        } catch (error) {
            console.error('Error cargando acciones activas:', error);
            accionesCount.textContent = '‚ö†Ô∏è Error cargando acciones activas';
            accionesCount.className = 'text-xs text-red-600 dark:text-red-400 font-bold';
            
            // Usar lista de respaldo
            cargarAccionesDeRespaldo();
        } finally {
            cargandoAcciones = false;
        }
    }
    
    // Funci√≥n para cargar todas las acciones (fallback)
    async function cargarTodasAcciones() {
        try {
            const response = await fetch('/api/acciones-disponibles');
            const data = await response.json();
            
            if (data.success && data.acciones && data.acciones.length > 0) {
                accionesActivas = data.acciones.map(acc => ({
                    ...acc,
                    dias_activos: 0,
                    variacion_promedio: 0,
                    tendencia: 'desconocida',
                    icono: 'üìä'
                }));
                
                accionesCount.textContent = `‚ö†Ô∏è ${accionesActivas.length} acciones totales (no filtradas por actividad)`;
                accionesCount.className = 'text-xs text-yellow-600 dark:text-yellow-400 font-bold';
            } else {
                cargarAccionesDeRespaldo();
            }
        } catch (error) {
            console.error('Error cargando todas las acciones:', error);
            cargarAccionesDeRespaldo();
        }
    }
    
    // Lista de respaldo (acciones m√°s comunes)
    function cargarAccionesDeRespaldo() {
        accionesActivas = [
            { simbolo: 'ARCA', nombre: 'ACCIONES COM. ARCA, C.A.', dias_activos: 22, variacion_promedio: 1.5, tendencia: 'alza', icono: 'üìà' },
            { simbolo: 'BFR', nombre: 'BANCO FONDO COM√öN, C.A.', dias_activos: 20, variacion_promedio: 0.8, tendencia: 'alza', icono: 'üìà' },
            { simbolo: 'RST', nombre: 'ROSTOCA, C.A.', dias_activos: 18, variacion_promedio: -0.5, tendencia: 'baja', icono: 'üìâ' },
            { simbolo: 'BNC', nombre: 'BANESCO, C.A.', dias_activos: 25, variacion_promedio: 2.1, tendencia: 'alza', icono: 'üìà' },
            { simbolo: 'MVZA', nombre: 'MERCAVARCA, C.A.', dias_activos: 15, variacion_promedio: 0.2, tendencia: 'estable', icono: '‚öñÔ∏è' },
            { simbolo: 'BVL', nombre: 'BANCO VENEZOLANO DE CR√âDITO', dias_activos: 23, variacion_promedio: 1.8, tendencia: 'alza', icono: 'üìà' },
            { simbolo: 'BVCC', nombre: 'BOLSA DE VALORES DE CARACAS', dias_activos: 30, variacion_promedio: 0.5, tendencia: 'estable', icono: '‚öñÔ∏è' },
            { simbolo: 'CCR', nombre: 'CER√ÅMICAS CARABOBO, C.A.', dias_activos: 12, variacion_promedio: -1.2, tendencia: 'baja', icono: 'üìâ' }
        ];
        
        accionesCount.textContent = `‚ö†Ô∏è Usando lista de respaldo (${accionesActivas.length} acciones)`;
        accionesCount.className = 'text-xs text-yellow-600 dark:text-yellow-400 font-bold';
    }
    
    // Funci√≥n para mostrar sugerencias filtradas
    function mostrarSugerencias(valor) {
        sugerenciasContainer.innerHTML = '';
        
        if (!valor.trim() || accionesActivas.length === 0) {
            sugerenciasContainer.classList.add('hidden');
            return;
        }
        
        valor = valor.toUpperCase();
        const sugerencias = accionesActivas.filter(accion => 
            accion.simbolo.includes(valor) || 
            (accion.nombre && accion.nombre.toUpperCase().includes(valor))
        );
        
        if (sugerencias.length === 0) {
            sugerenciasContainer.classList.add('hidden');
            return;
        }
        
        // Limitar a 20 sugerencias
        const mostrar = sugerencias.slice(0, 20);
        
        mostrar.forEach(accion => {
            const item = document.createElement('div');
            item.className = 'flex items-center gap-3 p-3 hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer border-b border-slate-100 dark:border-slate-700 last:border-b-0 transition-colors';
            
            // Color seg√∫n tendencia
            let colorTendencia = '';
            if (accion.tendencia === 'alza') {
                colorTendencia = 'text-green-600 dark:text-green-400';
            } else if (accion.tendencia === 'baja') {
                colorTendencia = 'text-red-600 dark:text-red-400';
            } else {
                colorTendencia = 'text-blue-600 dark:text-blue-400';
            }
            
            item.innerHTML = `
                <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-slate-100 to-slate-200 dark:from-slate-800 dark:to-slate-900 flex items-center justify-center p-1">
                    <img src="/static/img/logos/${accion.simbolo}.png" 
                         onerror="this.src='https://ui-avatars.com/api/?name=${accion.simbolo}&background=16a34a&color=fff&bold=true&size=256';" 
                         class="w-8 h-8 object-contain">
                </div>
                <div class="flex-1">
                    <div class="flex items-center gap-2">
                        <span class="font-black text-slate-800 dark:text-white uppercase">${accion.simbolo}</span>
                        <span class="text-xs ${colorTendencia}">${accion.icono}</span>
                    </div>
                    <div class="text-xs text-slate-500 dark:text-slate-400 truncate max-w-[200px]">${accion.nombre || accion.simbolo}</div>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-[10px] text-slate-400 dark:text-slate-500">${accion.dias_activos} d√≠as</span>
                        <span class="text-[10px] ${accion.variacion_promedio > 0 ? 'text-green-600 dark:text-green-400' : accion.variacion_promedio < 0 ? 'text-red-600 dark:text-red-400' : 'text-slate-400 dark:text-slate-500'}">
                            ${accion.variacion_promedio > 0 ? '+' : ''}${accion.variacion_promedio}%
                        </span>
                    </div>
                </div>
                <div class="text-xs text-green-600 dark:text-green-400 font-bold">
                    Seleccionar
                </div>
            `;
            
            item.addEventListener('click', function() {
                simboloInput.value = accion.simbolo;
                sugerenciasContainer.classList.add('hidden');
                accionesCount.textContent = `‚úÖ Seleccionado: ${accion.simbolo} (${accion.tendencia})`;
                simboloInput.focus();
            });
            
            sugerenciasContainer.appendChild(item);
        });
        
        // Agregar contador
        const contador = document.createElement('div');
        contador.className = 'p-2 text-xs text-center text-slate-500 dark:text-slate-400 bg-slate-50 dark:bg-slate-800';
        contador.textContent = `${sugerencias.length} de ${accionesActivas.length} acciones coinciden`;
        sugerenciasContainer.appendChild(contador);
        
        sugerenciasContainer.classList.remove('hidden');
    }
    
    // Funci√≥n para mostrar todas las acciones activas
    function mostrarTodasAccionesActivas() {
        if (accionesActivas.length === 0) {
            sugerenciasContainer.classList.add('hidden');
            return;
        }
        
        sugerenciasContainer.innerHTML = '';
        
        // Encabezado con estad√≠sticas
        const itemHeader = document.createElement('div');
        itemHeader.className = 'p-4 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 border-b border-slate-200 dark:border-slate-700';
        itemHeader.innerHTML = `
            <div class="text-sm font-black text-slate-700 dark:text-slate-300 uppercase mb-1">
                üéØ Acciones Activas - √öltimo Mes
            </div>
            <div class="text-xs text-slate-600 dark:text-slate-400 mb-2">
                ${accionesActivas.length} acciones con actividad reciente
            </div>
            <div class="flex gap-3 text-xs">
                <div class="flex items-center gap-1">
                    <span class="text-green-600">üìà</span>
                    <span>${accionesActivas.filter(a => a.tendencia === 'alza').length} en alza</span>
                </div>
                <div class="flex items-center gap-1">
                    <span class="text-red-600">üìâ</span>
                    <span>${accionesActivas.filter(a => a.tendencia === 'baja').length} en baja</span>
                </div>
                <div class="flex items-center gap-1">
                    <span class="text-blue-600">‚öñÔ∏è</span>
                    <span>${accionesActivas.filter(a => a.tendencia === 'estable').length} estables</span>
                </div>
            </div>
        `;
        sugerenciasContainer.appendChild(itemHeader);
        
        // Mostrar todas las acciones activas, agrupadas por tendencia
        const grupos = {
            'alza': accionesActivas.filter(a => a.tendencia === 'alza'),
            'estable': accionesActivas.filter(a => a.tendencia === 'estable'),
            'baja': accionesActivas.filter(a => a.tendencia === 'baja')
        };
        
        // Ordenar cada grupo por d√≠as activos
        Object.entries(grupos).forEach(([tendencia, accionesGrupo]) => {
            if (accionesGrupo.length === 0) return;
            
            const titulo = document.createElement('div');
            let tituloTexto = '';
            let colorClase = '';
            
            if (tendencia === 'alza') {
                tituloTexto = 'üìà En Alza';
                colorClase = 'text-green-700 dark:text-green-400 bg-green-50 dark:bg-green-900/20';
            } else if (tendencia === 'baja') {
                tituloTexto = 'üìâ En Baja';
                colorClase = 'text-red-700 dark:text-red-400 bg-red-50 dark:bg-red-900/20';
            } else {
                tituloTexto = '‚öñÔ∏è Estables';
                colorClase = 'text-blue-700 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20';
            }
            
            titulo.className = `p-3 text-xs font-bold ${colorClase} border-b border-slate-200 dark:border-slate-700`;
            titulo.textContent = `${tituloTexto} (${accionesGrupo.length})`;
            sugerenciasContainer.appendChild(titulo);
            
            accionesGrupo.forEach(accion => {
                const item = document.createElement('div');
                item.className = 'flex items-center gap-3 p-3 hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer border-b border-slate-100 dark:border-slate-700 last:border-b-0 transition-colors';
                
                let colorVar = '';
                if (accion.variacion_promedio > 0) {
                    colorVar = 'text-green-600 dark:text-green-400';
                } else if (accion.variacion_promedio < 0) {
                    colorVar = 'text-red-600 dark:text-red-400';
                } else {
                    colorVar = 'text-slate-400 dark:text-slate-500';
                }
                
                item.innerHTML = `
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-slate-100 to-slate-200 dark:from-slate-800 dark:to-slate-900 flex items-center justify-center p-1">
                        <img src="/static/img/logos/${accion.simbolo}.png" 
                             onerror="this.src='https://ui-avatars.com/api/?name=${accion.simbolo}&background=16a34a&color=fff&bold=true&size=256';" 
                             class="w-8 h-8 object-contain">
                    </div>
                    <div class="flex-1">
                        <div class="font-black text-slate-800 dark:text-white uppercase">${accion.simbolo}</div>
                        <div class="text-xs text-slate-500 dark:text-slate-400 truncate max-w-[200px]">${accion.nombre || accion.simbolo}</div>
                        <div class="flex items-center gap-3 mt-1">
                            <span class="text-[10px] text-slate-400 dark:text-slate-500">${accion.dias_activos} d√≠as</span>
                            <span class="text-[10px] ${colorVar}">
                                ${accion.variacion_promedio > 0 ? '+' : ''}${accion.variacion_promedio}%
                            </span>
                        </div>
                    </div>
                `;
                
                item.addEventListener('click', function() {
                    simboloInput.value = accion.simbolo;
                    sugerenciasContainer.classList.add('hidden');
                    accionesCount.textContent = `‚úÖ Seleccionado: ${accion.simbolo}`;
                    simboloInput.focus();
                });
                
                sugerenciasContainer.appendChild(item);
            });
        });
        
        // Pie de p√°gina
        const pie = document.createElement('div');
        pie.className = 'p-3 text-center text-xs text-slate-500 dark:text-slate-400 bg-slate-50 dark:bg-slate-800';
        pie.textContent = 'üí° Escribe para filtrar por s√≠mbolo o nombre';
        sugerenciasContainer.appendChild(pie);
        
        sugerenciasContainer.classList.remove('hidden');
    }
    
    // Event listeners
    simboloInput.addEventListener('input', function() {
        mostrarSugerencias(this.value);
    });
    
    simboloInput.addEventListener('focus', async function() {
        if (accionesActivas.length === 0 && !cargandoAcciones) {
            await cargarAccionesActivas();
        }
        
        if (!this.value.trim()) {
            mostrarTodasAccionesActivas();
        } else {
            mostrarSugerencias(this.value);
        }
    });
    
    // Ocultar lista al hacer clic fuera
    document.addEventListener('click', function(event) {
        if (!simboloInput.contains(event.target) && !sugerenciasContainer.contains(event.target)) {
            sugerenciasContainer.classList.add('hidden');
        }
    });
    
    // Manejar teclas
    simboloInput.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            sugerenciasContainer.classList.add('hidden');
        }
        if (event.key === 'ArrowDown' && sugerenciasContainer.classList.contains('hidden')) {
            sugerenciasContainer.classList.remove('hidden');
            mostrarTodasAccionesActivas();
        }
    });
    
    // Mostrar todas las acciones al hacer clic en el input si est√° vac√≠o
    simboloInput.addEventListener('click', async function() {
        if (accionesActivas.length === 0 && !cargandoAcciones) {
            await cargarAccionesActivas();
        }
        
        if (!this.value.trim()) {
            mostrarTodasAccionesActivas();
        }
    });
    
    // Cargar acciones autom√°ticamente despu√©s de un breve retraso
    setTimeout(() => {
        if (simboloInput && !cargandoAcciones && accionesActivas.length === 0) {
            cargarAccionesActivas();
        }
    }, 300);
});

// Agregar estilos CSS para el gr√°fico
const style = document.createElement('style');
style.textContent = `
.chart-container {
    position: relative;
    width: 100%;
}

/* Estilos para tooltips */
.chartjs-tooltip {
    border-radius: 8px !important;
    padding: 12px !important;
    background-color: rgba(15, 23, 42, 0.95) !important;
    border: 1px solid #475569 !important;
    backdrop-filter: blur(10px);
}

.chartjs-tooltip-key {
    display: inline-block;
    width: 10px;
    height: 10px;
    margin-right: 8px;
    border-radius: 2px;
}

/* Mejoras de accesibilidad */
@media (prefers-reduced-motion: reduce) {
    .chart-container {
        animation: none;
    }
}

/* Animaciones suaves */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.bg-white, .bg-slate-50, .chart-container {
    animation: fadeIn 0.5s ease-out;
}

/* Estilos para vista previa de imagen compartible */
#analisisPreviewContainer {
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

#canvasAnalisisPreview {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

/* Bot√≥n de compartir con animaci√≥n */
#compartirAnalisisBtn {
    position: relative;
    overflow: hidden;
}

#compartirAnalisisBtn:active {
    transform: scale(0.95);
}

/* Efecto de brillo en hover */
#compartirAnalisisBtn:hover::after {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(
        to bottom right,
        rgba(255, 255, 255, 0.1) 0%,
        rgba(255, 255, 255, 0.2) 50%,
        rgba(255, 255, 255, 0.1) 100%
    );
    transform: rotate(30deg);
    animation: shine 1.5s infinite;
}

@keyframes shine {
    0% {
        transform: translateX(-100%) translateY(-100%) rotate(30deg);
    }
    100% {
        transform: translateX(100%) translateY(100%) rotate(30deg);
    }
}
`;
document.head.appendChild(style);
</script>

{% else %}
<!-- Mensaje cuando no hay datos -->
<div class="text-center py-20 bg-gradient-to-br from-slate-100 to-slate-200 dark:from-slate-800/50 dark:to-slate-900/30 rounded-3xl border-2 border-dashed border-slate-300 dark:border-slate-700">
    <div class="text-6xl mb-4 animate-bounce">üìà</div>
    <h3 class="text-xl font-black">Sin datos hist√≥ricos para mostrar</h3>
    <p class="text-slate-500 dark:text-slate-400 max-w-md mx-auto mt-2">
        {% if simbolo %}
        No se encontraron registros para el s√≠mbolo 
        <span class="text-green-600 dark:text-green-400 font-bold">{{ simbolo }}</span> 
        en el per√≠odo del 
        <span class="text-blue-600 dark:text-blue-400 font-bold">{{ fecha_desde_formato }}</span> 
        al 
        <span class="text-blue-600 dark:text-blue-400 font-bold">{{ fecha_hasta_formato }}</span>.
        {% else %}
        Ingresa un s√≠mbolo y selecciona un rango de fechas para consultar el hist√≥rico.
        {% endif %}
    </p>
    
    <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-4 max-w-lg mx-auto">
        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/10 p-4 rounded-xl border border-blue-200 dark:border-blue-800/30">
            <span class="text-2xl">üîç</span>
            <p class="text-sm font-bold mt-2">Busca por S√≠mbolo</p>
            <p class="text-xs text-slate-500">Ej: ARCA, BFR, RST</p>
        </div>
        <div class="bg-gradient-to-br from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/10 p-4 rounded-xl border border-green-200 dark:border-green-800/30">
            <span class="text-2xl">üìÖ</span>
            <p class="text-sm font-bold mt-2">Selecciona Fechas</p>
            <p class="text-xs text-slate-500">Desde - Hasta</p>
        </div>
        <div class="bg-gradient-to-br from-purple-50 to-violet-50 dark:from-purple-900/20 dark:to-violet-900/10 p-4 rounded-xl border border-purple-200 dark:border-purple-800/30">
            <span class="text-2xl">üìä</span>
            <p class="text-sm font-bold mt-2">Visualiza Gr√°ficos</p>
            <p class="text-xs text-slate-500">Tendencias y estad√≠sticas</p>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}