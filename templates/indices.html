<!-- templates/indices.html - VERSI√ìN COMPLETAMENTE CORREGIDA -->
{% extends "base.html" %}

{% block title %}√çndice General IBC vs D√≥lar BCV - BVC{% endblock %}

{% block content %}
<div class="mb-8">
    <h2 class="text-3xl font-black italic uppercase tracking-tighter">√çndice Burs√°til de Caracas (IBC) vs D√≥lar BCV</h2>
    <p class="text-slate-500 dark:text-slate-400 font-bold uppercase text-xs tracking-widest">
        üìà Comparativa de rendimiento: Mercado burs√°til vs Tipo de cambio oficial
    </p>
</div>

<!-- Formulario de selecci√≥n de fechas -->
<div class="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-lg mb-6">
    <form action="/indices" method="GET" class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
            <label class="block text-sm font-bold mb-2 text-slate-700 dark:text-slate-300">Fecha Desde</label>
            <input type="date" name="fecha_desde" value="{{ fecha_desde }}" 
                   class="w-full p-3 rounded-lg border border-slate-200 dark:border-slate-700 dark:bg-slate-900 font-bold outline-none focus:ring-2 focus:ring-green-500 transition-all">
        </div>
        
        <div>
            <label class="block text-sm font-bold mb-2 text-slate-700 dark:text-slate-300">Fecha Hasta</label>
            <input type="date" name="fecha_hasta" value="{{ fecha_hasta }}" 
                   class="w-full p-3 rounded-lg border border-slate-200 dark:border-slate-700 dark:bg-slate-900 font-bold outline-none focus:ring-2 focus:ring-green-500 transition-all">
        </div>
        
        <div class="flex items-end">
            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-black uppercase text-sm shadow-lg transition-all active:scale-95">
                Consultar Comparativa
            </button>
        </div>
    </form>
    
    <!-- Botones de per√≠odo r√°pido -->
    <div class="mt-4 flex flex-wrap gap-2">
        <a href="/indices?fecha_desde={{ fecha_7d }}&fecha_hasta={{ fecha_hoy }}" 
           class="px-3 py-1.5 bg-slate-100 dark:bg-slate-700 rounded-lg text-xs font-bold hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">
            √öltimos 7 d√≠as
        </a>
        <a href="/indices?fecha_desde={{ fecha_30d }}&fecha_hasta={{ fecha_hoy }}" 
           class="px-3 py-1.5 bg-slate-100 dark:bg-slate-700 rounded-lg text-xs font-bold hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">
            √öltimos 30 d√≠as
        </a>
        <a href="/indices?fecha_desde={{ fecha_90d }}&fecha_hasta={{ fecha_hoy }}" 
           class="px-3 py-1.5 bg-slate-100 dark:bg-slate-700 rounded-lg text-xs font-bold hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">
            √öltimos 90 d√≠as
        </a>
        <a href="/indices?fecha_desde={{ fecha_365d }}&fecha_hasta={{ fecha_hoy }}" 
           class="px-3 py-1.5 bg-slate-100 dark:bg-slate-700 rounded-lg text-xs font-bold hover:bg-slate-200 dark:hover:bg-slate-600 transition-colors">
            √öltimo a√±o
        </a>
    </div>
</div>

<!-- INFORMACI√ìN SOBRE REEXPRESI√ìN MONETARIA -->
{% if estadisticas_indice and estadisticas_indice.get('ajustes') and estadisticas_indice.ajustes.get('ajustados', 0) > 0 %}
<div class="bg-gradient-to-r from-yellow-500 to-orange-500 dark:from-yellow-700 dark:to-orange-700 rounded-2xl p-6 mb-6 text-white shadow-xl">
    <div class="flex items-center gap-4">
        <div class="bg-white/20 p-4 rounded-2xl backdrop-blur-sm">
            <span class="text-3xl">üí∞</span>
        </div>
        <div class="flex-1">
            <h4 class="text-xl font-black mb-1">Ajuste por Reexpresi√≥n Monetaria</h4>
            <p class="text-white/90 mb-2">
                Valores anteriores al {{ estadisticas_indice.ajustes.get('fecha_reexpresion', '27/07/2025') }} fueron divididos entre {{ estadisticas_indice.ajustes.get('factor_conversion', 1000)|int }} 
                para normalizar la serie hist√≥rica.
            </p>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                <div class="bg-white/10 p-3 rounded-xl">
                    <p class="text-xs text-white/70 font-bold">Fecha Reexpresi√≥n</p>
                    <p class="font-black">{{ estadisticas_indice.ajustes.get('fecha_reexpresion', '27/07/2025') }}</p>
                </div>
                <div class="bg-white/10 p-3 rounded-xl">
                    <p class="text-xs text-white/70 font-bold">Factor de Conversi√≥n</p>
                    <p class="font-black">√∑{{ estadisticas_indice.ajustes.get('factor_conversion', 1000)|int }}</p>
                </div>
                <div class="bg-white/10 p-3 rounded-xl">
                    <p class="text-xs text-white/70 font-bold">Valores Ajustados</p>
                    <p class="font-black">{{ estadisticas_indice.ajustes.get('ajustados', 0) }}</p>
                </div>
                <div class="bg-white/10 p-3 rounded-xl">
                    <p class="text-xs text-white/70 font-bold">Valores Sin Ajustar</p>
                    <p class="font-black">{{ estadisticas_indice.ajustes.get('no_ajustados', 0) }}</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- RESUMEN COMPARATIVO -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- RESUMEN √çNDICE IBC -->
    {% if indice %}
    <div class="bg-gradient-to-r from-blue-500 to-indigo-600 dark:from-blue-700 dark:to-indigo-800 rounded-2xl p-6 text-white shadow-xl">
        <div class="flex items-center gap-4 mb-4">
            <div class="bg-white/20 p-3 rounded-2xl backdrop-blur-sm">
                <span class="text-2xl">üìä</span>
            </div>
            <div>
                <h4 class="text-xl font-black">√çndice Burs√°til de Caracas</h4>
                <p class="text-white/70 text-sm">IBC - Mercado de Valores</p>
            </div>
        </div>
        
        <div class="text-center mb-4">
            <p class="text-white/80 text-sm font-bold uppercase">Valor Actual</p>
            <p class="text-4xl font-black mt-1">{{ "{:,.2f}".format(indice.get('valor', 0)) }}</p>
            {% if indice.get('ajustado') and indice.get('valor_original') %}
            <p class="text-sm text-white/70 mt-1">
                <span class="line-through">{{ "{:,.2f}".format(indice.get('valor_original', 0)) }}</span>
                <span class="text-yellow-300 ml-2">(√∑{{ factor_conversion }})</span>
            </p>
            {% endif %}
        </div>
        
        <div class="grid grid-cols-2 gap-4">
            <div class="bg-white/10 p-3 rounded-xl">
                <p class="text-white/70 text-xs font-bold uppercase">Variaci√≥n Diaria</p>
                <p class="text-lg font-black {% if indice.get('variacion', 0) > 0 %}text-green-300{% elif indice.get('variacion', 0) < 0 %}text-red-300{% endif %}">
                    {% if indice.get('variacion', 0) > 0 %}+{% endif %}{{ "{:,.2f}".format(indice.get('variacion', 0)) }}%
                </p>
            </div>
            <div class="bg-white/10 p-3 rounded-xl">
                <p class="text-white/70 text-xs font-bold uppercase">Variaci√≥n Per√≠odo</p>
                <p class="text-lg font-black {% if indice.get('var_rel_historica', 0) > 0 %}text-green-300{% elif indice.get('var_rel_historica', 0) < 0 %}text-red-300{% endif %}">
                    {% if indice.get('var_rel_historica', 0) > 0 %}+{% endif %}{{ "{:,.2f}".format(indice.get('var_rel_historica', 0)) }}%
                </p>
            </div>
        </div>
        
        <div class="mt-4 text-sm text-white/80">
            <p>üìÖ {{ fecha_desde }} a {{ fecha_hasta }}</p>
            <p class="mt-1">
                {% if indice.get('fuente') == 'manual' %}
                üìù Datos Manuales
                {% else %}
                üåê Datos Autom√°ticos
                {% endif %}
                {% if indice.get('ajustado') %}
                <span class="text-yellow-300"> ‚Ä¢ Ajustado</span>
                {% endif %}
            </p>
        </div>
    </div>
    {% endif %}
    
    <!-- RESUMEN D√ìLAR BCV -->
    {% if datos_dolar_bcv and datos_dolar_bcv|length > 0 %}
    {% set ultimo_dolar = datos_dolar_bcv[-1] %}
    <div class="bg-gradient-to-r from-red-500 to-pink-600 dark:from-red-700 dark:to-pink-800 rounded-2xl p-6 text-white shadow-xl">
        <div class="flex items-center gap-4 mb-4">
            <div class="bg-white/20 p-3 rounded-2xl backdrop-blur-sm">
                <span class="text-2xl">üíµ</span>
            </div>
            <div>
                <h4 class="text-xl font-black">D√≥lar BCV</h4>
                <p class="text-white/70 text-sm">Tasa Oficial del Banco Central</p>
            </div>
        </div>
        
        <div class="text-center mb-4">
            <p class="text-white/80 text-sm font-bold uppercase">Tasa Actual</p>
            <p class="text-4xl font-black mt-1">{{ "{:,.2f}".format(ultimo_dolar.get('tasa', 0)) }} <span class="text-lg">Bs/$</span></p>
        </div>
        
        <div class="grid grid-cols-2 gap-4">
            <div class="bg-white/10 p-3 rounded-xl">
                <p class="text-white/70 text-xs font-bold uppercase">Variaci√≥n Diaria</p>
                <p class="text-lg font-black {% if ultimo_dolar.get('variacion', 0) > 0 %}text-red-300{% elif ultimo_dolar.get('variacion', 0) < 0 %}text-green-300{% endif %}">
                    {% if ultimo_dolar.get('variacion', 0) > 0 %}+{% endif %}{{ "{:,.2f}".format(ultimo_dolar.get('variacion', 0)) }}%
                </p>
            </div>
            <div class="bg-white/10 p-3 rounded-xl">
                <p class="text-white/70 text-xs font-bold uppercase">Variaci√≥n Per√≠odo</p>
                {% if datos_dolar_bcv|length > 1 %}
                {% set primer_dolar = datos_dolar_bcv[0] %}
                {% if primer_dolar.get('tasa', 0) > 0 %}
                    {% set variacion_dolar = ((ultimo_dolar.get('tasa', 0) - primer_dolar.get('tasa', 0)) / primer_dolar.get('tasa', 0) * 100) %}
                    <p class="text-lg font-black {% if variacion_dolar > 0 %}text-red-300{% elif variacion_dolar < 0 %}text-green-300{% endif %}">
                        {% if variacion_dolar > 0 %}+{% endif %}{{ "{:,.2f}".format(variacion_dolar) }}%
                    </p>
                {% else %}
                    <p class="text-lg font-black">N/A</p>
                {% endif %}
                {% else %}
                <p class="text-lg font-black">N/A</p>
                {% endif %}
            </div>
        </div>
        
        <div class="mt-4 text-sm text-white/80">
            <p>üìÖ {{ fecha_desde }} a {{ fecha_hasta }}</p>
            <p class="mt-1">üí∞ {{ datos_dolar_bcv|length }} d√≠as con datos</p>
        </div>
    </div>
    {% endif %}
</div>

<!-- COMPARATIVA DE RENDIMIENTO -->
{% if indice and datos_dolar_bcv and datos_dolar_bcv|length > 0 and datos_dolar_bcv|length > 1 %}
<div class="bg-gradient-to-r from-green-500 to-emerald-600 dark:from-green-700 dark:to-emerald-800 rounded-2xl p-6 mb-6 text-white shadow-xl">
    <div class="flex items-center gap-4 mb-4">
        <div class="bg-white/20 p-3 rounded-2xl backdrop-blur-sm">
            <span class="text-2xl">‚öñÔ∏è</span>
        </div>
        <div>
            <h4 class="text-xl font-black">Comparativa de Rendimiento</h4>
            <p class="text-white/70 text-sm">IBC vs D√≥lar BCV en el per√≠odo seleccionado</p>
        </div>
    </div>
    
    {% set primer_dolar = datos_dolar_bcv[0] %}
    {% set ultimo_dolar = datos_dolar_bcv[-1] %}
    {% set variacion_dolar = 0 %}
    {% if primer_dolar.get('tasa', 0) > 0 %}
        {% set variacion_dolar = ((ultimo_dolar.get('tasa', 0) - primer_dolar.get('tasa', 0)) / primer_dolar.get('tasa', 0) * 100) %}
    {% endif %}
    {% set diferencia = indice.get('var_rel_historica', 0) - variacion_dolar %}
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-white/10 p-4 rounded-xl">
            <p class="text-white/70 text-xs font-bold uppercase">Rendimiento IBC</p>
            <p class="text-2xl font-black {% if indice.get('var_rel_historica', 0) > 0 %}text-green-300{% elif indice.get('var_rel_historica', 0) < 0 %}text-red-300{% endif %}">
                {% if indice.get('var_rel_historica', 0) > 0 %}+{% endif %}{{ "{:,.2f}".format(indice.get('var_rel_historica', 0)) }}%
            </p>
        </div>
        
        <div class="bg-white/10 p-4 rounded-xl">
            <p class="text-white/70 text-xs font-bold uppercase">Rendimiento $BCV</p>
            <p class="text-2xl font-black {% if variacion_dolar > 0 %}text-red-300{% elif variacion_dolar < 0 %}text-green-300{% endif %}">
                {% if variacion_dolar > 0 %}+{% endif %}{{ "{:,.2f}".format(variacion_dolar) }}%
            </p>
        </div>
        
        <div class="bg-white/10 p-4 rounded-xl">
            <p class="text-white/70 text-xs font-bold uppercase">Diferencia</p>
            <p class="text-2xl font-black {% if diferencia > 0 %}text-green-300{% elif diferencia < 0 %}text-red-300{% else %}text-yellow-300{% endif %}">
                {% if diferencia > 0 %}+{% endif %}{{ "{:,.2f}".format(diferencia) }}%
            </p>
            <p class="text-xs text-white/70 mt-1">
                {% if diferencia > 5 %}
                üìà IBC supera significativamente al d√≥lar
                {% elif diferencia > 0 %}
                üìà IBC rinde mejor que el d√≥lar
                {% elif diferencia > -5 %}
                ‚öñÔ∏è Rendimientos similares
                {% else %}
                üìâ D√≥lar rinde mejor que IBC
                {% endif %}
            </p>
        </div>
    </div>
</div>
{% endif %}

<!-- GR√ÅFICO COMPARATIVO -->
<div class="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-lg mb-6">
    <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-4 gap-4">
        <div>
            <h3 class="text-xl font-black text-slate-800 dark:text-white">Comparativa: √çndice IBC vs D√≥lar BCV</h3>
            <p class="text-sm text-slate-500 dark:text-slate-400">
                üìä Evoluci√≥n comparada del mercado burs√°til y la tasa oficial del d√≥lar
            </p>
        </div>
        
        <div class="flex flex-wrap gap-3">
            <!-- Selector de visualizaci√≥n -->
            <div class="flex items-center gap-2">
                <button id="btnMostrarAmbos" class="px-3 py-1.5 bg-green-600 text-white rounded-lg text-xs font-bold hover:bg-green-700 transition-colors">
                    Ambos
                </button>
                <button id="btnMostrarIBC" class="px-3 py-1.5 bg-slate-200 dark:bg-slate-700 rounded-lg text-xs font-bold hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors">
                    Solo IBC
                </button>
                <button id="btnMostrarDolar" class="px-3 py-1.5 bg-slate-200 dark:bg-slate-700 rounded-lg text-xs font-bold hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors">
                    Solo $BCV
                </button>
            </div>
            
            <!-- Selector de escala -->
            <div class="flex items-center gap-2">
                <select id="escalaGrafico" class="p-2 text-sm bg-slate-100 dark:bg-slate-700 rounded-lg border border-slate-300 dark:border-slate-600">
                    <option value="separado">Escalas separadas</option>
                    <option value="normalizado">Valores normalizados (%)</option>
                </select>
            </div>
        </div>
    </div>
    
    <div class="chart-container" style="height: 450px;">
        <canvas id="comparativaChart"></canvas>
    </div>
    
    {% if not labels or labels|length == 0 %}
    <div class="text-center py-10">
        <div class="text-4xl mb-2">üìä</div>
        <h4 class="text-lg font-black mb-2">No hay datos disponibles</h4>
        <p class="text-slate-500 dark:text-slate-400">Selecciona otro rango de fechas para visualizar la comparativa.</p>
    </div>
    {% endif %}
    
    <!-- Leyenda -->
    <div class="mt-6 pt-6 border-t border-slate-200 dark:border-slate-700">
        <div class="flex flex-wrap gap-6 items-center justify-center text-sm">
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 bg-blue-500 rounded-full"></div>
                <span class="text-slate-700 dark:text-slate-300 font-bold">√çndice IBC</span>
                <span class="text-slate-500 dark:text-slate-400 text-xs">
                    {% if indice %}
                    {{ "{:,.2f}".format(indice.get('valor', 0)) }}
                    {% if indice.get('var_rel_historica', 0) > 0 %}(+{% endif %}{{ "{:,.2f}".format(indice.get('var_rel_historica', 0)) }}%)
                    {% endif %}
                </span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-4 h-4 bg-red-500 rounded-full"></div>
                <span class="text-slate-700 dark:text-slate-300 font-bold">D√≥lar BCV</span>
                <span class="text-slate-500 dark:text-slate-400 text-xs">
                    {% if datos_dolar_bcv and datos_dolar_bcv|length > 0 %}
                    {% set ultimo_dolar = datos_dolar_bcv[-1] %}
                    {{ "{:,.2f}".format(ultimo_dolar.get('tasa', 0)) }} Bs/$
                    {% endif %}
                </span>
            </div>
            {% if estadisticas_indice and estadisticas_indice.get('ajustes') and estadisticas_indice.ajustes.get('ajustados', 0) > 0 %}
            <div class="flex items-center gap-2">
                <span class="text-yellow-600 dark:text-yellow-400 font-bold">üí∞</span>
                <span class="text-slate-700 dark:text-slate-300 font-bold">Valores ajustados √∑{{ estadisticas_indice.ajustes.get('factor_conversion', 1000)|int }}</span>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- ESTAD√çSTICAS DETALLADAS -->
{% if estadisticas_indice and estadisticas_indice.get('total_datos', 0) > 0 %}
<div class="bg-white dark:bg-slate-800 rounded-2xl p-6 shadow-lg">
    <h3 class="text-xl font-black text-slate-800 dark:text-white mb-4">Estad√≠sticas Detalladas</h3>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Estad√≠sticas del √çndice -->
        <div class="space-y-4">
            <h4 class="font-bold text-lg flex items-center gap-2">
                <span class="text-blue-500">üìä</span>
                Estad√≠sticas del √çndice IBC
            </h4>
            
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-slate-50 dark:bg-slate-900 p-4 rounded-xl">
                    <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase">Valor M√°ximo</p>
                    <p class="text-xl font-black text-green-600 dark:text-green-400">
                        {{ "{:,.2f}".format(estadisticas_indice.get('maximo', 0)) }}
                    </p>
                </div>
                <div class="bg-slate-50 dark:bg-slate-900 p-4 rounded-xl">
                    <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase">Valor M√≠nimo</p>
                    <p class="text-xl font-black text-red-600 dark:text-red-400">
                        {{ "{:,.2f}".format(estadisticas_indice.get('minimo', 0)) }}
                    </p>
                </div>
                <div class="bg-slate-50 dark:bg-slate-900 p-4 rounded-xl">
                    <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase">Promedio</p>
                    <p class="text-xl font-black">
                        {{ "{:,.2f}".format(estadisticas_indice.get('promedio', 0)) }}
                    </p>
                </div>
                <div class="bg-slate-50 dark:bg-slate-900 p-4 rounded-xl">
                    <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase">Datos</p>
                    <p class="text-xl font-black">
                        {{ estadisticas_indice.get('total_datos', 0) }} d√≠as
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Estad√≠sticas del D√≥lar - CORREGIDO -->
        <div class="space-y-4">
            <h4 class="font-bold text-lg flex items-center gap-2">
                <span class="text-red-500">üíµ</span>
                Estad√≠sticas del D√≥lar BCV
            </h4>
            
            {% if datos_dolar_bcv and datos_dolar_bcv|length > 0 %}
                <!-- Calcular estad√≠sticas del d√≥lar directamente en Jinja2 -->
                {% set max_tasa = 0 %}
                {% set min_tasa = 99999999 %}
                {% set sum_tasa = 0 %}
                {% set count_tasa = 0 %}
                
                {% for d in datos_dolar_bcv %}
                    {% if d.get('tasa', 0) > 0 %}
                        {% if d.tasa > max_tasa %}{% set max_tasa = d.tasa %}{% endif %}
                        {% if d.tasa < min_tasa %}{% set min_tasa = d.tasa %}{% endif %}
                        {% set sum_tasa = sum_tasa + d.tasa %}
                        {% set count_tasa = count_tasa + 1 %}
                    {% endif %}
                {% endfor %}
                
                {% if count_tasa > 0 %}
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-slate-50 dark:bg-slate-900 p-4 rounded-xl">
                        <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase">Tasa M√°xima</p>
                        <p class="text-xl font-black text-red-600 dark:text-red-400">
                            {{ "{:,.2f}".format(max_tasa) }} Bs/$
                        </p>
                    </div>
                    <div class="bg-slate-50 dark:bg-slate-900 p-4 rounded-xl">
                        <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase">Tasa M√≠nima</p>
                        <p class="text-xl font-black text-green-600 dark:text-green-400">
                            {{ "{:,.2f}".format(min_tasa) }} Bs/$
                        </p>
                    </div>
                    <div class="bg-slate-50 dark:bg-slate-900 p-4 rounded-xl">
                        <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase">Promedio</p>
                        <p class="text-xl font-black">
                            {{ "{:,.2f}".format(sum_tasa / count_tasa) }} Bs/$
                        </p>
                    </div>
                    <div class="bg-slate-50 dark:bg-slate-900 p-4 rounded-xl">
                        <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase">Datos</p>
                        <p class="text-xl font-black">
                            {{ datos_dolar_bcv|length }} d√≠as
                        </p>
                    </div>
                </div>
                {% else %}
                <div class="bg-slate-50 dark:bg-slate-900 p-4 rounded-xl">
                    <p class="text-slate-500 dark:text-slate-400">No hay datos suficientes del d√≥lar BCV</p>
                </div>
                {% endif %}
            {% else %}
            <div class="bg-slate-50 dark:bg-slate-900 p-4 rounded-xl">
                <p class="text-slate-500 dark:text-slate-400">No hay datos del d√≥lar BCV para este per√≠odo</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Informaci√≥n del per√≠odo -->
    <div class="mt-6 pt-6 border-t border-slate-200 dark:border-slate-700">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-slate-50 dark:bg-slate-900 p-4 rounded-xl">
                <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase">Per√≠odo Analizado</p>
                <p class="font-black">{{ fecha_desde }} a {{ fecha_hasta }}</p>
                <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">{{ total_dias }} d√≠as totales</p>
            </div>
            <div class="bg-slate-50 dark:bg-slate-900 p-4 rounded-xl">
                <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase">Cobertura de Datos</p>
                <p class="font-black">{{ fechas_con_datos }} / {{ total_dias }} d√≠as</p>
                <div class="w-full bg-slate-200 dark:bg-slate-700 h-2 rounded-full mt-2 overflow-hidden">
                    <div class="bg-green-500 h-2 rounded-full" 
                         style="width: {{ (fechas_con_datos / total_dias * 100)|round|int if total_dias > 0 else 0 }}%"></div>
                </div>
                <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">
                    {{ (fechas_con_datos / total_dias * 100)|round|int if total_dias > 0 else 0 }}% de cobertura
                </p>
            </div>
            {% if estadisticas_indice.get('ajustes') and estadisticas_indice.ajustes.get('ajustados', 0) > 0 %}
            <div class="bg-gradient-to-r from-yellow-100 to-orange-100 dark:from-yellow-900/30 dark:to-orange-900/30 p-4 rounded-xl border border-yellow-200 dark:border-yellow-800">
                <p class="text-yellow-700 dark:text-yellow-300 text-xs font-bold uppercase">Ajuste Aplicado</p>
                <p class="font-black text-yellow-700 dark:text-yellow-300">
                    {{ estadisticas_indice.ajustes.get('ajustados', 0) }} valores √∑{{ estadisticas_indice.ajustes.get('factor_conversion', 1000)|int }}
                </p>
                <p class="text-sm text-yellow-600 dark:text-yellow-400 mt-1">
                    Reexpresi√≥n: {{ estadisticas_indice.ajustes.get('fecha_reexpresion', '27/07/2025') }}
                </p>
            </div>
            {% else %}
            <div class="bg-slate-50 dark:bg-slate-900 p-4 rounded-xl">
                <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase">Estado</p>
                <p class="font-black">Datos actuales</p>
                <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Sin ajuste por reexpresi√≥n</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

<!-- Script para el gr√°fico comparativo - CORREGIDO -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Verificar si hay datos para mostrar
    const labels = {{ labels|tojson|safe if labels else '[]' }};
    const valoresIBC = {{ valores|tojson|safe if valores else '[]' }};
    const valoresDolar = {{ dolar_tasas|tojson|safe if dolar_tasas else '[]' }};
    
    console.log("üìä Datos para gr√°fico comparativo:", { 
        labels: labels.length, 
        valoresIBC: valoresIBC.length,
        valoresDolar: valoresDolar.length,
        valoresIBCSample: valoresIBC.slice(0, 3),
        valoresDolarSample: valoresDolar.slice(0, 3)
    });
    
    if (!labels || labels.length === 0 || valoresIBC.length === 0) {
        console.log("‚ö†Ô∏è No hay datos para mostrar en el gr√°fico comparativo");
        return;
    }
    
    const ctx = document.getElementById('comparativaChart').getContext('2d');
    
    // Normalizar datos para comparaci√≥n porcentual
    function normalizarDatos(datos) {
        if (!datos || datos.length === 0) return [];
        
        // Encontrar el primer valor v√°lido (no cero)
        let primerValor = 0;
        for (let i = 0; i < datos.length; i++) {
            if (datos[i] > 0) {
                primerValor = datos[i];
                break;
            }
        }
        
        if (primerValor === 0) return datos;
        
        return datos.map(valor => ((valor / primerValor) - 1) * 100);
    }
    
    // Crear el gr√°fico comparativo
    let chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: '√çndice IBC',
                    data: valoresIBC,
                    borderColor: 'rgb(59, 130, 246)', // Azul
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 3,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    pointBackgroundColor: 'rgba(59, 130, 246, 0.8)',
                    pointBorderColor: 'rgb(59, 130, 246)',
                    pointBorderWidth: 1,
                    yAxisID: 'y',
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'D√≥lar BCV (Bs/$)',
                    data: valoresDolar,
                    borderColor: 'rgb(239, 68, 68)', // Rojo
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    borderWidth: 3,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    pointBackgroundColor: 'rgba(239, 68, 68, 0.8)',
                    pointBorderColor: 'rgb(239, 68, 68)',
                    pointBorderWidth: 1,
                    yAxisID: 'y1',
                    fill: false,
                    tension: 0.4,
                    borderDash: [5, 5] // L√≠nea punteada para diferenciar
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            stacked: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        font: {
                            size: 12
                        },
                        padding: 20,
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(15, 23, 42, 0.95)',
                    titleFont: {
                        size: 12,
                        weight: 'bold'
                    },
                    bodyFont: {
                        size: 12
                    },
                    padding: 12,
                    borderColor: 'rgba(255, 255, 255, 0.1)',
                    borderWidth: 1,
                    cornerRadius: 8,
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            let value = context.parsed.y;
                            
                            if (label.includes('IBC')) {
                                label += `: ${value.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                            } else if (label.includes('D√≥lar')) {
                                label += `: ${value.toLocaleString('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} Bs/$`;
                            }
                            
                            return label;
                        },
                        title: function(context) {
                            return `Fecha: ${context[0].label}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: true,
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45,
                        font: {
                            size: 11
                        }
                    }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: '√çndice IBC',
                        color: 'rgb(59, 130, 246)',
                        font: {
                            size: 12,
                            weight: 'bold'
                        }
                    },
                    grid: {
                        drawOnChartArea: true,
                        color: 'rgba(59, 130, 246, 0.1)'
                    },
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString('es-VE');
                        },
                        font: {
                            size: 11
                        }
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'D√≥lar BCV (Bs/$)',
                        color: 'rgb(239, 68, 68)',
                        font: {
                            size: 12,
                            weight: 'bold'
                        }
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString('es-VE');
                        },
                        font: {
                            size: 11
                        }
                    }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeOutQuart'
            }
        }
    });
    
    // Funcionalidad para cambiar visualizaci√≥n
    function updateButtonStyles(activeButton) {
        const buttons = ['btnMostrarAmbos', 'btnMostrarIBC', 'btnMostrarDolar'];
        buttons.forEach(btnId => {
            const btn = document.getElementById(btnId);
            if (btnId === activeButton) {
                btn.classList.add('bg-green-600', 'text-white');
                btn.classList.remove('bg-slate-200', 'dark:bg-slate-700');
            } else {
                btn.classList.remove('bg-green-600', 'text-white');
                btn.classList.add('bg-slate-200', 'dark:bg-slate-700');
            }
        });
    }
    
    document.getElementById('btnMostrarAmbos').addEventListener('click', function() {
        chart.data.datasets[0].hidden = false;
        chart.data.datasets[1].hidden = false;
        chart.options.scales.y.display = true;
        chart.options.scales.y1.display = true;
        chart.update();
        updateButtonStyles('btnMostrarAmbos');
    });
    
    document.getElementById('btnMostrarIBC').addEventListener('click', function() {
        chart.data.datasets[0].hidden = false;
        chart.data.datasets[1].hidden = true;
        chart.options.scales.y.display = true;
        chart.options.scales.y1.display = false;
        chart.update();
        updateButtonStyles('btnMostrarIBC');
    });
    
    document.getElementById('btnMostrarDolar').addEventListener('click', function() {
        chart.data.datasets[0].hidden = true;
        chart.data.datasets[1].hidden = false;
        chart.options.scales.y.display = false;
        chart.options.scales.y1.display = true;
        chart.update();
        updateButtonStyles('btnMostrarDolar');
    });
    
    // Funcionalidad para cambiar escala
    document.getElementById('escalaGrafico').addEventListener('change', function() {
        const escala = this.value;
        
        if (escala === 'normalizado') {
            // Convertir a porcentajes normalizados
            const ibcNormalizado = normalizarDatos(valoresIBC);
            const dolarNormalizado = normalizarDatos(valoresDolar);
            
            chart.data.datasets[0].data = ibcNormalizado;
            chart.data.datasets[1].data = dolarNormalizado;
            
            chart.options.scales.y.title.text = 'Variaci√≥n % IBC';
            chart.options.scales.y1.title.text = 'Variaci√≥n % $BCV';
            
            chart.options.scales.y.ticks.callback = function(value) {
                                return value.toFixed(1) + '%';
            };
            
            chart.options.scales.y1.ticks.callback = function(value) {
                return value.toFixed(1) + '%';
            };
        } else {
            // Volver a valores originales
            chart.data.datasets[0].data = valoresIBC;
            chart.data.datasets[1].data = valoresDolar;
            
            chart.options.scales.y.title.text = '√çndice IBC';
            chart.options.scales.y1.title.text = 'D√≥lar BCV (Bs/$)';
            
            chart.options.scales.y.ticks.callback = function(value) {
                return value.toLocaleString('es-VE');
            };
            
            chart.options.scales.y1.ticks.callback = function(value) {
                return value.toLocaleString('es-VE');
            };
        }
        
        chart.update();
    });
    
    // Inicializar con ambos visibles
    updateButtonStyles('btnMostrarAmbos');
});
</script>

<style>
.chart-container {
    position: relative;
    width: 100%;
}

/* Animaciones suaves */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.bg-gradient-to-r, .bg-white, .bg-slate-50 {
    animation: fadeIn 0.5s ease-out;
}
</style>

{% endblock %}