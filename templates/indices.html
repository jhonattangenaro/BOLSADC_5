<!-- templates/indices.html - VERSI칍N RESPONSIVA -->
{% extends "base.html" %}

{% block title %}칈ndice General IBC vs D칩lar BCV - BVC{% endblock %}

{% block content %}
<div class="mb-6 md:mb-8">
    <h2 class="text-2xl md:text-3xl font-black italic uppercase tracking-tighter">칈ndice Burs치til vs D칩lar BCV</h2>
    <p class="text-slate-500 dark:text-slate-400 font-bold uppercase text-xs tracking-widest">
        游늳 Comparativa de rendimiento: Mercado burs치til vs Tipo de cambio
    </p>
</div>

<!-- Formulario de selecci칩n de fechas -->
<div class="bg-white dark:bg-slate-800 rounded-xl md:rounded-2xl p-4 md:p-6 shadow-lg mb-4 md:mb-6">
    <form action="/indices" method="GET" class="grid grid-cols-1 md:grid-cols-3 gap-3 md:gap-4">
        <div>
            <label class="block text-xs md:text-sm font-bold mb-1 md:mb-2 text-slate-700 dark:text-slate-300">Fecha Desde</label>
            <input type="date" name="fecha_desde" value="{{ fecha_desde }}" 
                   class="w-full p-3 rounded-lg border border-slate-200 dark:border-slate-700 dark:bg-slate-900 font-bold outline-none focus:ring-2 focus:ring-green-500 transition-all text-sm md:text-base">
        </div>
        
        <div>
            <label class="block text-xs md:text-sm font-bold mb-1 md:mb-2 text-slate-700 dark:text-slate-300">Fecha Hasta</label>
            <input type="date" name="fecha_hasta" value="{{ fecha_hasta }}" 
                   class="w-full p-3 rounded-lg border border-slate-200 dark:border-slate-700 dark:bg-slate-900 font-bold outline-none focus:ring-2 focus:ring-green-500 transition-all text-sm md:text-base">
        </div>
        
        <div class="flex items-end">
            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 md:px-6 py-3 rounded-lg font-black uppercase text-xs md:text-sm shadow-lg transition-all active:scale-95">
                Consultar
            </button>
        </div>
    </form>
</div>

<!-- RESUMEN COMPARATIVO -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6 mb-4 md:mb-6">
    <!-- RESUMEN 칈NDICE IBC -->
    {% if indice %}
    <div class="bg-gradient-to-r from-blue-500 to-indigo-600 dark:from-blue-700 dark:to-indigo-800 rounded-xl md:rounded-2xl p-4 md:p-6 text-white shadow-xl">
        <div class="flex items-center gap-3 md:gap-4 mb-3 md:mb-4">
            <div class="bg-white/20 p-2 md:p-3 rounded-xl md:rounded-2xl backdrop-blur-sm">
                <span class="text-xl md:text-2xl">游늵</span>
            </div>
            <div>
                <h4 class="text-lg md:text-xl font-black">칈ndice Burs치til de Caracas</h4>
                <p class="text-white/70 text-xs md:text-sm">IBC - Mercado de Valores</p>
            </div>
        </div>
        
        <div class="text-center mb-3 md:mb-4">
            <p class="text-white/80 text-xs md:text-sm font-bold uppercase">Valor Actual</p>
            <p class="text-3xl md:text-4xl font-black mt-1">{{ "{:,.2f}".format(indice.get('valor', 0)) }}</p>
        </div>
        
        <div class="grid grid-cols-2 gap-3 md:gap-4">
            <div class="bg-white/10 p-2 md:p-3 rounded-lg md:rounded-xl">
                <p class="text-white/70 text-xs font-bold uppercase">Variaci칩n Diaria</p>
                <p class="text-base md:text-lg font-black {% if indice.get('variacion', 0) > 0 %}text-green-300{% elif indice.get('variacion', 0) < 0 %}text-red-300{% endif %}">
                    {% if indice.get('variacion', 0) > 0 %}+{% endif %}{{ "{:,.2f}".format(indice.get('variacion', 0)) }}%
                </p>
            </div>
            <div class="bg-white/10 p-2 md:p-3 rounded-lg md:rounded-xl">
                <p class="text-white/70 text-xs font-bold uppercase">Variaci칩n Per칤odo</p>
                <p class="text-base md:text-lg font-black {% if indice.get('var_rel_historica', 0) > 0 %}text-green-300{% elif indice.get('var_rel_historica', 0) < 0 %}text-red-300{% endif %}">
                    {% if indice.get('var_rel_historica', 0) > 0 %}+{% endif %}{{ "{:,.2f}".format(indice.get('var_rel_historica', 0)) }}%
                </p>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- RESUMEN D칍LAR BCV -->
    {% if datos_dolar_bcv and datos_dolar_bcv|length > 0 %}
    {% set ultimo_dolar = datos_dolar_bcv[-1] %}
    <div class="bg-gradient-to-r from-red-500 to-pink-600 dark:from-red-700 dark:to-pink-800 rounded-xl md:rounded-2xl p-4 md:p-6 text-white shadow-xl">
        <div class="flex items-center gap-3 md:gap-4 mb-3 md:mb-4">
            <div class="bg-white/20 p-2 md:p-3 rounded-xl md:rounded-2xl backdrop-blur-sm">
                <span class="text-xl md:text-2xl">游눳</span>
            </div>
            <div>
                <h4 class="text-lg md:text-xl font-black">D칩lar BCV</h4>
                <p class="text-white/70 text-xs md:text-sm">Tasa Oficial del Banco Central</p>
            </div>
        </div>
        
        <div class="text-center mb-3 md:mb-4">
            <p class="text-white/80 text-xs md:text-sm font-bold uppercase">Tasa Actual</p>
            <p class="text-3xl md:text-4xl font-black mt-1">{{ "{:,.2f}".format(ultimo_dolar.get('tasa', 0)) }} <span class="text-base md:text-lg">Bs/$</span></p>
        </div>
        
        <div class="grid grid-cols-2 gap-3 md:gap-4">
            <div class="bg-white/10 p-2 md:p-3 rounded-lg md:rounded-xl">
                <p class="text-white/70 text-xs font-bold uppercase">Variaci칩n Diaria</p>
                <p class="text-base md:text-lg font-black {% if ultimo_dolar.get('variacion', 0) > 0 %}text-red-300{% elif ultimo_dolar.get('variacion', 0) < 0 %}text-green-300{% endif %}">
                    {% if ultimo_dolar.get('variacion', 0) > 0 %}+{% endif %}{{ "{:,.2f}".format(ultimo_dolar.get('variacion', 0)) }}%
                </p>
            </div>
            <div class="bg-white/10 p-2 md:p-3 rounded-lg md:rounded-xl">
                <p class="text-white/70 text-xs font-bold uppercase">Variaci칩n Per칤odo</p>
                {% if datos_dolar_bcv|length > 1 %}
                {% set primer_dolar = datos_dolar_bcv[0] %}
                {% if primer_dolar.get('tasa', 0) > 0 %}
                    {% set variacion_dolar = ((ultimo_dolar.get('tasa', 0) - primer_dolar.get('tasa', 0)) / primer_dolar.get('tasa', 0) * 100) %}
                    <p class="text-base md:text-lg font-black {% if variacion_dolar > 0 %}text-red-300{% elif variacion_dolar < 0 %}text-green-300{% endif %}">
                        {% if variacion_dolar > 0 %}+{% endif %}{{ "{:,.2f}".format(variacion_dolar) }}%
                    </p>
                {% else %}
                    <p class="text-base md:text-lg font-black">N/A</p>
                {% endif %}
                {% else %}
                <p class="text-base md:text-lg font-black">N/A</p>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- GR츼FICO COMPARATIVO -->
<div class="bg-white dark:bg-slate-800 rounded-xl md:rounded-2xl p-4 md:p-6 shadow-lg mb-4 md:mb-6">
    <div class="flex flex-col md:flex-row items-start md:items-center justify-between mb-3 md:mb-4 gap-2 md:gap-4">
        <div>
            <h3 class="text-lg md:text-xl font-black text-slate-800 dark:text-white">Comparativa: 칈ndice IBC vs D칩lar BCV</h3>
            <p class="text-xs md:text-sm text-slate-500 dark:text-slate-400">
                游늵 Evoluci칩n comparada
            </p>
        </div>
    </div>
    
    <div class="chart-container" style="height: 300px; min-height: 250px;">
        <canvas id="comparativaChart"></canvas>
    </div>
    
    {% if not labels or labels|length == 0 %}
    <div class="text-center py-8 md:py-10">
        <div class="text-3xl md:text-4xl mb-2">游늵</div>
        <h4 class="text-base md:text-lg font-black mb-2">No hay datos disponibles</h4>
        <p class="text-slate-500 dark:text-slate-400 text-sm">Selecciona otro rango de fechas.</p>
    </div>
    {% endif %}
</div>

<!-- ESTAD칈STICAS DETALLADAS -->
{% if estadisticas_indice and estadisticas_indice.get('total_datos', 0) > 0 %}
<div class="bg-white dark:bg-slate-800 rounded-xl md:rounded-2xl p-4 md:p-6 shadow-lg">
    <h3 class="text-lg md:text-xl font-black text-slate-800 dark:text-white mb-3 md:mb-4">Estad칤sticas Detalladas</h3>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
        <!-- Estad칤sticas del 칈ndice -->
        <div class="space-y-3 md:space-y-4">
            <h4 class="font-bold text-base md:text-lg flex items-center gap-2">
                <span class="text-blue-500">游늵</span>
                Estad칤sticas del 칈ndice IBC
            </h4>
            
            <div class="grid grid-cols-2 gap-3 md:gap-4">
                <div class="bg-slate-50 dark:bg-slate-900 p-3 md:p-4 rounded-lg md:rounded-xl">
                    <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase">Valor M치ximo</p>
                    <p class="text-lg md:text-xl font-black text-green-600 dark:text-green-400">
                        {{ "{:,.2f}".format(estadisticas_indice.get('maximo', 0)) }}
                    </p>
                </div>
                <div class="bg-slate-50 dark:bg-slate-900 p-3 md:p-4 rounded-lg md:rounded-xl">
                    <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase">Valor M칤nimo</p>
                    <p class="text-lg md:text-xl font-black text-red-600 dark:text-red-400">
                        {{ "{:,.2f}".format(estadisticas_indice.get('minimo', 0)) }}
                    </p>
                </div>
                <div class="bg-slate-50 dark:bg-slate-900 p-3 md:p-4 rounded-lg md:rounded-xl">
                    <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase">Promedio</p>
                    <p class="text-lg md:text-xl font-black">
                        {{ "{:,.2f}".format(estadisticas_indice.get('promedio', 0)) }}
                    </p>
                </div>
                <div class="bg-slate-50 dark:bg-slate-900 p-3 md:p-4 rounded-lg md:rounded-xl">
                    <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase">Datos</p>
                    <p class="text-lg md:text-xl font-black">
                        {{ estadisticas_indice.get('total_datos', 0) }} d칤as
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Informaci칩n del per칤odo -->
    <div class="mt-4 md:mt-6 pt-4 md:pt-6 border-t border-slate-200 dark:border-slate-700">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 md:gap-4">
            <div class="bg-slate-50 dark:bg-slate-900 p-3 md:p-4 rounded-lg md:rounded-xl">
                <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase">Per칤odo Analizado</p>
                <p class="font-bold text-sm md:text-base">{{ fecha_desde }} a {{ fecha_hasta }}</p>
            </div>
            <div class="bg-slate-50 dark:bg-slate-900 p-3 md:p-4 rounded-lg md:rounded-xl">
                <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase">Cobertura de Datos</p>
                <p class="font-bold text-sm md:text-base">{{ fechas_con_datos }} / {{ total_dias }} d칤as</p>
            </div>
            <div class="bg-slate-50 dark:bg-slate-900 p-3 md:p-4 rounded-lg md:rounded-xl">
                <p class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase">Estado</p>
                <p class="font-bold text-sm md:text-base">Datos actuales</p>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Script para el gr치fico comparativo - RESPONSIVO -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const labels = {{ labels|tojson|safe if labels else '[]' }};
    const valoresIBC = {{ valores|tojson|safe if valores else '[]' }};
    const valoresDolar = {{ dolar_tasas|tojson|safe if dolar_tasas else '[]' }};
    
    if (!labels || labels.length === 0 || valoresIBC.length === 0) {
        return;
    }
    
    const ctx = document.getElementById('comparativaChart').getContext('2d');
    
    // Ajustar configuraci칩n seg칰n tama침o de pantalla
    const isMobile = window.innerWidth < 768;
    const pointRadius = isMobile ? 1 : 2;
    const borderWidth = isMobile ? 2 : 3;
    const fontSize = isMobile ? 9 : 11;
    
    // Crear el gr치fico comparativo
    let chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: '칈ndice IBC',
                    data: valoresIBC,
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: borderWidth,
                    pointRadius: pointRadius,
                    pointHoverRadius: pointRadius + 2,
                    pointBackgroundColor: 'rgba(59, 130, 246, 0.8)',
                    pointBorderColor: 'rgb(59, 130, 246)',
                    pointBorderWidth: 1,
                    yAxisID: 'y',
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'D칩lar BCV (Bs/$)',
                    data: valoresDolar,
                    borderColor: 'rgb(239, 68, 68)',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    borderWidth: borderWidth,
                    pointRadius: pointRadius,
                    pointHoverRadius: pointRadius + 2,
                    pointBackgroundColor: 'rgba(239, 68, 68, 0.8)',
                    pointBorderColor: 'rgb(239, 68, 68)',
                    pointBorderWidth: 1,
                    yAxisID: 'y1',
                    fill: false,
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            stacked: false,
            plugins: {
                legend: {
                    display: !isMobile,
                    position: 'top',
                    labels: {
                        font: {
                            size: fontSize
                        },
                        padding: 10,
                        usePointStyle: true,
                    }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(15, 23, 42, 0.95)',
                    titleFont: {
                        size: fontSize
                    },
                    bodyFont: {
                        size: fontSize
                    },
                    padding: 8,
                    borderColor: 'rgba(255, 255, 255, 0.1)',
                    borderWidth: 1,
                    cornerRadius: 6
                }
            },
            scales: {
                x: {
                    grid: {
                        display: true,
                        color: 'rgba(0, 0, 0, 0.05)'
                    },
                    ticks: {
                        maxRotation: isMobile ? 90 : 45,
                        minRotation: isMobile ? 90 : 45,
                        font: {
                            size: fontSize - 1
                        }
                    }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: !isMobile,
                        text: '칈ndice IBC',
                        color: 'rgb(59, 130, 246)',
                        font: {
                            size: fontSize,
                            weight: 'bold'
                        }
                    },
                    grid: {
                        drawOnChartArea: true,
                        color: 'rgba(59, 130, 246, 0.1)'
                    },
                    ticks: {
                        callback: function(value) {
                            if (value >= 1000) {
                                return (value/1000).toFixed(0) + 'k';
                            }
                            return value.toLocaleString('es-VE', {maximumFractionDigits: 0});
                        },
                        font: {
                            size: fontSize - 1
                        }
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: !isMobile,
                        text: 'D칩lar BCV (Bs/$)',
                        color: 'rgb(239, 68, 68)',
                        font: {
                            size: fontSize,
                            weight: 'bold'
                        }
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString('es-VE', {maximumFractionDigits: 0});
                        },
                        font: {
                            size: fontSize - 1
                        }
                    }
                }
            }
        }
    });
    
    // Redimensionar gr치fico al cambiar tama침o de ventana
    window.addEventListener('resize', function() {
        const isMobileNow = window.innerWidth < 768;
        const newPointRadius = isMobileNow ? 1 : 2;
        const newBorderWidth = isMobileNow ? 2 : 3;
        const newFontSize = isMobileNow ? 9 : 11;
        
        chart.options.plugins.legend.display = !isMobileNow;
        chart.options.scales.x.ticks.maxRotation = isMobileNow ? 90 : 45;
        chart.options.scales.x.ticks.minRotation = isMobileNow ? 90 : 45;
        chart.options.scales.x.ticks.font.size = newFontSize - 1;
        chart.options.scales.y.ticks.font.size = newFontSize - 1;
        chart.options.scales.y1.ticks.font.size = newFontSize - 1;
        chart.options.plugins.tooltip.titleFont.size = newFontSize;
        chart.options.plugins.tooltip.bodyFont.size = newFontSize;
        chart.options.scales.y.title.display = !isMobileNow;
        chart.options.scales.y1.title.display = !isMobileNow;
        
        chart.data.datasets.forEach(dataset => {
            dataset.pointRadius = newPointRadius;
            dataset.borderWidth = newBorderWidth;
            dataset.pointHoverRadius = newPointRadius + 2;
        });
        
        chart.update();
    });
});
</script>

<style>
/* Optimizaciones para responsividad */
.chart-container {
    position: relative;
    width: 100%;
}

@media (max-width: 768px) {
    /* Mejorar legibilidad en m칩vil */
    body {
        font-size: 14px;
        line-height: 1.5;
    }
    
    /* Ajustar contenedores */
    .max-w-6xl {
        padding-left: 0.75rem;
        padding-right: 0.75rem;
    }
    
    /* Optimizar m치rgenes */
    .mb-4 {
        margin-bottom: 1rem;
    }
    
    /* Ajustar botones */
    button, .btn {
        min-height: 44px;
    }
}

/* Mejoras para tablet */
@media (min-width: 769px) and (max-width: 1024px) {
    .max-w-6xl {
        max-width: 90%;
    }
}

/* Asegurar que las im치genes sean responsivas */
img {
    max-width: 100%;
    height: auto;
}

/* Mejorar scroll en m칩vil */
.overflow-x-auto {
    -webkit-overflow-scrolling: touch;
}

/* Optimizar toques en m칩vil */
@media (hover: none) and (pointer: coarse) {
    button:active, a:active {
        opacity: 0.7;
        transform: scale(0.98);
    }
}
</style>

{% endblock %}
